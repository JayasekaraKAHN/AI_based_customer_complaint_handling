<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>MSISDN Information</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    .tab-content {
      margin-top: 20px;
      height: 200px;
    }

    .logout-btn {
      position: absolute;
      top: 20px;
      right: 20px;
    }

    .map-preview {
      height: 300px;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
    }

  </style>
</head>

<body>
  <div class="container mt-5">
    <a href="{{ url_for('logout') }}" class="btn btn-outline-danger logout-btn">
      Logout
    </a>
    <div class="col-md-6 offset-md-3">
      <div class="card p-4 shadow-sm">
        <h2 class="mb-4">Enter MSISDN to Retrieve Information</h2>
        <form action="/search" method="POST">
          <div class="mb-3">
            <label for="msisdn" class="form-label">MSISDN</label>
            <input type="text" class="form-control" id="msisdn" name="msisdn" required />
          </div>
          <button type="submit" class="btn btn-primary w-100">Search</button>
        </form>
      </div>
    </div>
  </div>

  {% if result %}
  <div class="container-fluid px-4 mt-4">
    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs" id="infoTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button"
          role="tab" aria-controls="details" aria-selected="true">
          Details
        </button>
      </li>
      <!-- NEW MAP TAB - ADDED -->
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="location-tab" data-bs-toggle="tab" data-bs-target="#location" type="button"
          role="tab" aria-controls="location" aria-selected="false">
          Location Map
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="graphs-tab" data-bs-toggle="tab" data-bs-target="#graphs" type="button" role="tab"
          aria-controls="graphs" aria-selected="false">
          Usage Graphs
        </button>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="infoTabsContent">
      <div class="tab-pane fade show active" id="details" role="tabpanel" aria-labelledby="details-tab">
        <div class="card p-4 mt-3">
          1. Subscriber Identification
          <table class="table table-bordered">
            <tr>
              <td><strong>MSISDN:</strong></td>
              <td>{{ result['MSISDN'] }}</td>
            </tr>
            <tr>
              <td><strong>IMSI:</strong></td>
              <td>{{ result['IMSI'] }}</td>
            </tr>
            <tr>
              <td><strong>IMEI:</strong></td> 
              <td>{{ result['IMEI']}}</td>
            </tr>
          </table>

          <br>
          2. Device Information
          <table class="table table-bordered">
            <tr>
              <td><strong>Device Manufacturer:</strong></td>
              <td>{{ result['Brand']}}</td>
            </tr>
            <tr>
              <td><strong>Model</strong></td>
              <td>{{ result['Model'] }}</td>
            </tr>
            <tr>
              <td><strong>Hardware Type</strong></td>
              <td>{{ result['Primary Hardware Type'] }}</td>
            </tr>
            <tr>
              <td><strong>Operating System Version</strong></td>
              <td>{{ result['OS'] }}</td>
            </tr>
            <tr>
              <td><strong>VoLTE Support</strong></td>
              <td>{{ result['VoLTE'] }}</td>
            </tr>
            <tr>
              <td><strong>SIM Type</strong></td>
              <td>{{ result['SIM Type'] }}</td>
            </tr>
            <tr>
              <td><strong>VoLTE-provisioning Status</strong></td> <!---->
            </tr>
          </table>
          <br>

          3. Location Data
          <table class="table table-bordered">
            <tr>
              <td>Recent Cell Location</td>
            </tr>
            <tr>
              <td><strong>Cell Code:</strong></td>
              <td>{{ result['Cellcode'] }}</td>
            </tr>
            <tr>
              <td><strong>Site Name:</strong></td>
              <td>{{ result['Sitename'] }}</td>
            </tr>
            <tr>
              <td><strong>Coordinates:</strong></td>
              <td>Lat: {{ result['Lat'] }}, Lon: {{ result['Lon'] }}</td>
            </tr>
            <tr>
              <td><strong>Region:</strong></td>
              <td>{{ result['Region'] }}</td>
            </tr>
            <tr>
              <td><strong>District:</strong></td>
              <td>{{ result['District'] }}</td>
            </tr>
            <tr>
              <td><strong>LAC:</strong></td>
              <td>{{ result['LAC'] }}</td>
            </tr>
            <tr>
              <td><strong>SAC:</strong></td>
              <td>{{ result['SAC'] }}</td>
            </tr>
            {% if result["Common Cell Locations"] %}
            {% for loc in result["Common Cell Locations"] %}
            <tr>
              <td>Common Cell Locations (Recent Activity)</td>
            </tr>
            <tr>
              <td><strong>Cell Code</strong></td>
              <td>{{ loc.CELL_CODE }}</td>
            </tr>
            <tr>
              <td><strong>Site Name</strong></td>
              <td>{{ loc.SITE_NAME }}</td>
            </tr>
            <tr>
              <td><strong>Coordinates:</strong></td>
              <td>
                {% if loc.LAT and loc.LON and loc.LAT != 'Not Found' and loc.LON != 'Not Found' %}
                  Lat: {{ loc.LAT }}, Lon: {{ loc.LON }}
                {% else %}
                  Not Available
                {% endif %}
              </td>
            </tr>
            <tr>
              <td><strong>District</strong></td>
              <td>{{ loc.DISTRICT }}</td>
            </tr>
            <tr>
              <td><strong>LAC</strong></td>
              <td>{{ loc.LAC }}</td>
            </tr>
            <tr>
              <td><strong>CELL</strong></td>
              <td>{{ loc.CELL }}</td>
            </tr>
            {% if not loop.last %}
            <tr><td colspan="2" style="border-top: 2px solid #dee2e6;"></td></tr>
            {% endif %}
            {% endfor %}
            {% else %}
            <tr>
              <td><strong>Common Locations:</strong></td>
              <td class="text-muted">No common locations found for this MSISDN.</td>
            </tr>
            {% endif %}
          </table>

            <br>
        </div>
      </div>

      <!-- Location Map Tab Content - UPDATED -->
      <div class="tab-pane fade" id="location" role="tabpanel" aria-labelledby="location-tab">
        <div class="card p-4 mt-3">
          <div class="map-preview mb-3">
            {% if has_map %}
            <iframe src="{{ url_for('static', filename='temp_map.html') }}" width="100%" height="100%"
              frameborder="0"></iframe>
            {% else %}
            <div class="d-flex align-items-center justify-content-center h-100 bg-light">
              <div class="text-center">
                <p class="mb-2">Other regions map preview not available</p>
                <small class="text-muted">Click "View Other Regions Map" to explore</small>
              </div>
            </div>
            {% endif %}
          </div>

          <div class="d-flex gap-2 flex-wrap">
            <a href="{{ url_for('show_map', msisdn=result.MSISDN) }}" class="btn btn-success" target="_blank">
              View Full Map
            </a>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="graphs" role="tabpanel" aria-labelledby="graphs-tab">
        <div class="row mt-3">
          <!-- Line Chart -->
          <div class="col-md-6 mb-4">
            <div class="card border p-3">
              <div id="monthlyVolumeChart" style="width: 100%; height: 400px"></div>
            </div>
          </div>

          <!-- Bar Chart -->
          <div class="col-md-6 mb-4">
            <div class="card border p-3">
              <div id="totalVolumeChart" style="width: 100%; height: 400px"></div>
            </div>
          </div>
          <!-- Voice Usage Chart -->
          <div class="col-md-6 mb-4">
            <div class="card border p-3">
              <div id="voiceUsageChart" style="width: 100%; height: 400px"></div>
            </div>
          </div>
          <!--SMS Usage Chart-->
          <div class="col-md-6 mb-4">
            <div class="card border p-3">
              <div id="smsUsageChart" style="width: 100%; height: 400px"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const usage = JSON.parse('{{ result["Monthly Usage"] | tojson | safe }}');

    // Line Chart (by network type)
    const networkTraces = ["2G", "3G", "4G", "5G"].map((net) => ({
      x: usage.months,
      y: usage[net],
      name: net,
      mode: "lines+markers",
      type: "scatter",
    }));

    const networkLayout = {
      title: "Monthly Data Volume by Network",
      xaxis: { title: "Month" },
      yaxis: { title: "Volume (MB)" },
    };

    Plotly.newPlot("monthlyVolumeChart", networkTraces, networkLayout, {
      responsive: true,
    });

    // Bar Chart (total usage)
    const totalBarTrace = {
      x: usage.months,
      y: usage.Total,
      name: "Total Usage",
      type: "bar",
      marker: { color: "#007bff" },
      width: 0.5,
    };

    const totalLayout = {
      title: "Total Monthly Data Usage",
      xaxis: { title: "Month" },
      yaxis: { title: "Total Volume (MB)" },
    };

    Plotly.newPlot("totalVolumeChart", [totalBarTrace], totalLayout, {
      responsive: true,
    });

    // Voice Usage Chart
    const voiceTraces = ["incoming_voice", "outgoing_voice"].map((type) => ({
      x: usage.months,
      y: usage[type],
      name: type === "incoming_voice" ? "Incoming Voice" : "Outgoing Voice",
      mode: "lines+markers",
      type: "scatter",
    }));

    const voiceLayout = {
      title: "Monthly Voice Usage",
      xaxis: { title: "Month" },
      yaxis: { title: "Voice Usage (Minutes)" },
    };

    Plotly.newPlot("voiceUsageChart", voiceTraces, voiceLayout, {
      responsive: true,
    });

    //SMS Usage Chart
    const smsTraces = ["incoming_sms", "outgoing_sms"].map((type) => ({
      x: usage.months,
      y: usage[type],
      name: type === "incoming_sms" ? "Incoming SMS" : "Outgoing SMS",
      mode: "lines+markers",
      type: "scatter",
    }));

    const smsLayout = {
      title: "Monthly SMS Usage",
      xaxis: { title: "Month" },
      yaxis: { title: "SMS Usage" },
    };

    Plotly.newPlot("smsUsageChart", smsTraces, smsLayout, {
      responsive: true,
    });
  </script>

  {% elif error %}
  <div class="container mt-4">
    <div class="alert alert-danger"><strong>Error:</strong> {{ error }}</div>
  </div>
  {% endif %}

  <!-- Bootstrap JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
</body>

</html>