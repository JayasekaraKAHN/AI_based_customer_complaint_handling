<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>MSISDN Information</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    .tab-content {
      margin-top: 20px;
      height: 200px;
    }

    .logout-btn {
      position: absolute;
      top: 20px;
      right: 20px;
    }

    .map-preview {
      height: 300px;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
    }

    /* RSRP Table Styles */
    .rsrp-site-cell {
      background-color: #f8f9fa !important;
      font-weight: bold !important;
      border-right: 2px solid #dee2e6 !important;
      vertical-align: middle !important;
    }

    .rsrp-site-id-cell {
      background-color: #e9ecef !important;
      font-weight: 600 !important;
      border-right: 1px solid #dee2e6 !important;
      vertical-align: middle !important;
    }

    .rsrp-row {
      border-bottom: 1px solid #e9ecef;
    }

    .rsrp-row:hover {
      background-color: #f5f5f5;
    }

    /* Range Filter Styling */
    .range-filter-group {
      border: 1px solid #e9ecef;
      border-radius: 6px;
      padding: 8px;
      background-color: #f8f9fa;
    }

    .range-filter-group label {
      font-weight: 600;
      color: #495057;
    }

    .legacy-filters {
      border-top: 1px solid #dee2e6;
      padding-top: 12px;
      margin-top: 8px;
    }

    /* Table header filter styling */
    #rsrpTable th {
      vertical-align: top;
      padding: 12px 8px;
      min-width: 140px;
    }

    #rsrpTable th input.form-control-sm {
      font-size: 0.75rem;
      padding: 2px 6px;
      height: auto;
    }

    #rsrpTable th .row {
      margin: 0;
    }

    #rsrpTable th .col-6 {
      padding: 0 2px;
    }

    /* Common Location RSRP Table Styling */
    .common-rsrp-filter-form {
      font-size: 0.9rem;
    }

    .common-rsrp-filter-form .form-control-sm,
    .common-rsrp-filter-form .form-select-sm {
      font-size: 0.8rem;
    }

    #commonRsrpTable1 th,
    #commonRsrpTable2 th,
    #commonRsrpTable3 th,
    #commonRsrpTable4 th,
    #commonRsrpTable5 th,
    #commonRsrpTable6 th,
    #commonRsrpTable7 th,
    #commonRsrpTable8 th {
      vertical-align: top;
      padding: 10px 6px;
      min-width: 120px;
    }

    #commonRsrpTable1 th input.form-control-sm,
    #commonRsrpTable2 th input.form-control-sm,
    #commonRsrpTable3 th input.form-control-sm,
    #commonRsrpTable4 th input.form-control-sm,
    #commonRsrpTable5 th input.form-control-sm,
    #commonRsrpTable6 th input.form-control-sm,
    #commonRsrpTable7 th input.form-control-sm,
    #commonRsrpTable8 th input.form-control-sm {
      font-size: 0.7rem;
      padding: 2px 4px;
      height: auto;
    }

    .card-header h6 {
      margin-bottom: 2px;
    }
  </style>
</head>

<body>
  <div class="container mt-5">
    <a href="{{ url_for('logout') }}" class="btn btn-outline-danger logout-btn">
      Logout
    </a>
    <div class="col-md-6 offset-md-3">
      <div class="card p-4 shadow-sm">
        <h2 class="mb-4">Enter MSISDN to Retrieve Information</h2>
        <form action="/search" method="POST">
          <div class="mb-3">
            <label for="msisdn" class="form-label">MSISDN</label>
            <input type="text" class="form-control" id="msisdn" name="msisdn" required />
          </div>
          <button type="submit" class="btn btn-primary w-100">Search</button>
        </form>
      </div>
    </div>
  </div>

  {% if result %}
  <div class="container-fluid px-4 mt-4">
    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs" id="infoTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button"
          role="tab" aria-controls="details" aria-selected="true">
          Details
        </button>
      </li>
      <!-- NEW MAP TAB - ADDED -->
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="location-tab" data-bs-toggle="tab" data-bs-target="#location" type="button"
          role="tab" aria-controls="location" aria-selected="false">
          Location Map
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="graphs-tab" data-bs-toggle="tab" data-bs-target="#graphs" type="button" role="tab"
          aria-controls="graphs" aria-selected="false">
          Usage Graphs
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="rsrp-tab" data-bs-toggle="tab" data-bs-target="#rsrp" type="button" role="tab"
          aria-controls="rsrp" aria-selected="false">
          RSRP Data
        </button>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="infoTabsContent">
      <div class="tab-pane fade show active" id="details" role="tabpanel" aria-labelledby="details-tab">
        <div class="card p-4 mt-3">
          1. Subscriber Identification
          <table class="table table-bordered">
            <tr>
              <td><strong>MSISDN:</strong></td>
              <td>{{ result['MSISDN'] }}</td>
            </tr>
            <tr>
              <td><strong>IMSI:</strong></td>
              <td>{{ result['IMSI'] }}</td>
            </tr>
            <tr>
              <td><strong>IMEI:</strong></td>
              <td>{{ result['IMEI']}}</td>
            </tr>
          </table>

          <br>
          2. Device Information
          <table class="table table-bordered">
            <tr>
              <td><strong>Device Manufacturer:</strong></td>
              <td>{{ result['Brand']}}</td>
            </tr>
            <tr>
              <td><strong>Model</strong></td>
              <td>{{ result['Model'] }}</td>
            </tr>
            <tr>
              <td><strong>Device Type</strong></td>
              <td>{{ result['Device Type'] }}</td>
            </tr>
            <tr>
              <td><strong>Primary Hardware Type</strong></td>
              <td>{{ result['Primary Hardware Type'] }}</td>
            </tr>
            <tr>
              <td><strong>Year Released</strong></td>
              <td>{{ result['Year Released'] }}</td>
            </tr>
            <tr>
              <td><strong>Operating System Version</strong></td>
              <td>{{ result['OS'] }}</td>
            </tr>
            <tr>
              <td><strong>VoLTE Support</strong></td>
              <td>{{ result['VoLTE'] }}</td>
            </tr>
            <tr>
              <td><strong>SIM Type</strong></td>
              <td>{{ result['SIM Type'] }}</td>
            </tr>
            <tr>
              <td><strong>VoLTE-provisioning Status</strong></td> <!---->
            </tr>
          </table>
          <br>

          3. Location Data
          <table class="table table-bordered">
            <tr>
              <td>Recent Cell Location</td>
            </tr>
            <tr>
              <td><strong>Cell Code:</strong></td>
              <td>{{ result['Cellcode'] }}</td>
            </tr>
            <tr>
              <td><strong>Site Name:</strong></td>
              <td>{{ result['Sitename'] }}</td>
            </tr>
            <tr>
              <td><strong>Coordinates:</strong></td>
              <td>Lat: {{ result['Lat'] }}, Lon: {{ result['Lon'] }}</td>
            </tr>
            <tr>
              <td><strong>Region:</strong></td>
              <td>{{ result['Region'] }}</td>
            </tr>
            <tr>
              <td><strong>District:</strong></td>
              <td>{{ result['District'] }}</td>
            </tr>
            <tr>
              <td><strong>LAC:</strong></td>
              <td>{{ result['LAC'] }}</td>
            </tr>
            <tr>
              <td><strong>Cell_ID:</strong></td>
              <td>{{ result['SAC'] }}</td>
            </tr>
            {% if result["Common Cell Locations"] %}
            {% for loc in result["Common Cell Locations"] %}
            <tr>
              <td>Common Cell Location</td>
            </tr>
            <tr>
              <td><strong>Cell Code</strong></td>
              <td>{{ loc.CELL_CODE }}</td>
            </tr>
            <tr>
              <td><strong>Site Name</strong></td>
              <td>{{ loc.SITE_NAME }}</td>
            </tr>
            <tr>
              <td><strong>Coordinates:</strong></td>
              <td>
                {% if loc.LAT and loc.LON and loc.LAT != 'Not Found' and loc.LON != 'Not Found' %}
                Lat: {{ loc.LAT }}, Lon: {{ loc.LON }}
                {% else %}
                Not Available
                {% endif %}
              </td>
            </tr>
            <tr>
              <td><strong>District</strong></td>
              <td>{{ loc.DISTRICT }}</td>
            </tr>
            <tr>
              <td><strong>LAC</strong></td>
              <td>{{ loc.LAC }}</td>
            </tr>
            <tr>
              <td><strong>Cell_ID</strong></td>
              <td>{{ loc.CELL }}</td>
            </tr>
            {% if not loop.last %}
            <tr>
              <td colspan="2" style="border-top: 2px solid #dee2e6;"></td>
            </tr>
            {% endif %}
            {% endfor %}
            {% else %}
            <tr>
              <td><strong>Common Locations:</strong></td>
              <td class="text-muted">No common locations found for this MSISDN.</td>
            </tr>
            {% endif %}
          </table>

          <br>
        </div>
      </div>

      <!-- Location Map Tab Content-->
      <div class="tab-pane fade" id="location" role="tabpanel" aria-labelledby="location-tab">
        <div class="card p-4 mt-3">
          <div class="map-preview mb-3">
            {% if has_map %}
            <iframe src="{{ url_for('static', filename='temp_map.html') }}" width="100%" height="100%"
              frameborder="0"></iframe>
            {% else %}
            <div class="d-flex align-items-center justify-content-center h-100 bg-light">
              <div class="text-center">
                <p class="mb-2">Other regions map preview not available</p>
                <small class="text-muted">Click "View Other Regions Map" to explore</small>
              </div>
            </div>
            {% endif %}
          </div>

          <div class="d-flex gap-2 flex-wrap">
            <a href="{{ url_for('show_map', msisdn=result.MSISDN) }}" class="btn btn-success" target="_blank">
              View Full Map
            </a>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="graphs" role="tabpanel" aria-labelledby="graphs-tab">
        <div class="row mt-3">
          <!-- Line Chart -->
          <div class="col-md-6 mb-4">
            <div class="card border p-3">
              <div id="monthlyVolumeChart" style="width: 100%; height: 400px"></div>
            </div>
          </div>

          <!-- Bar Chart -->
          <div class="col-md-6 mb-4">
            <div class="card border p-3">
              <div id="totalVolumeChart" style="width: 100%; height: 400px"></div>
            </div>
          </div>
          <!-- Voice Usage Chart -->
          <div class="col-md-6 mb-4">
            <div class="card border p-3">
              <div id="voiceUsageChart" style="width: 100%; height: 400px"></div>
            </div>
          </div>
          <!--SMS Usage Chart-->
          <div class="col-md-6 mb-4">
            <div class="card border p-3">
              <div id="smsUsageChart" style="width: 100%; height: 400px"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- RSRP Data Tab Content -->
      <div class="tab-pane fade" id="rsrp" role="tabpanel" aria-labelledby="rsrp-tab">
        <div class="card p-4 mt-3">
          <h5>RSRP for Recent Location</h5>

          <!-- RSRP Filtering Controls -->
          <div class="row mb-3">
            <div class="col-md-12">
              <div class="bg-light p-3 rounded">
                <form id="rsrpFilterForm">
                  <input type="hidden" name="msisdn" value="{{ result['MSISDN'] }}">
                  <div class="row g-2 mb-2">
                    <div class="col-md-2">
                      <input type="text" name="cell_name_filter" placeholder="Filter by Cell Name..."
                        class="form-control form-control-sm">
                    </div>
                    <div class="col-md-3">
                      <select name="sort_by" class="form-select form-select-sm">
                        <option value="">Sort by...</option>
                        <option value="Cell_Name">Cell Name</option>
                        <option value="Site_ID">Site ID</option>
                        <option value="Site_Name">Site Name</option>
                        <option value="RSRP Range 1 (>-105dBm) %">RSRP Range 1</option>
                        <option value="RSRP Range 2 (-105~-110dBm) %">RSRP Range 2</option>
                        <option value="RSRP Range 3 (-110~-115dBm) %">RSRP Range 3</option>
                        <option value="RSRP < -115dBm %">RSRP < -115dBm</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <select name="sort_order" class="form-select form-select-sm">
                        <option value="asc">Ascending</option>
                        <option value="desc">Descending</option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <button type="button" onclick="applyRsrpFilters()" class="btn btn-primary btn-sm">Apply
                        Filters</button>
                      <button type="button" onclick="clearRsrpFilters()" class="btn btn-secondary btn-sm">Clear
                        Filters</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- RSRP Table -->
          <div id="rsrpTableContainer">
            <table class="table table-bordered" id="rsrpTable">
              <thead>
                <tr>
                  <th>Site Name</th>
                  <th>Site ID</th>
                  <th>Cell Name</th>
                  <th>
                    <div class="text-center">RSRP Range 1 (>-105dBm) %</div>
                    <div class="mt-2">
                      <div class="row g-1">
                        <div class="col-6">
                          <input type="number" name="rsrp_range1_min" placeholder="Min %" step="0.01"
                            class="form-control form-control-sm" form="rsrpFilterForm">
                        </div>
                        <div class="col-6">
                          <input type="number" name="rsrp_range1_max" placeholder="Max %" step="0.01"
                            class="form-control form-control-sm" form="rsrpFilterForm">
                        </div>
                      </div>
                    </div>
                  </th>
                  <th>
                    <div class="text-center">RSRP Range 2 (-105~-110dBm) %</div>
                    <div class="mt-2">
                      <div class="row g-1">
                        <div class="col-6">
                          <input type="number" name="rsrp_range2_min" placeholder="Min %" step="0.01"
                            class="form-control form-control-sm" form="rsrpFilterForm">
                        </div>
                        <div class="col-6">
                          <input type="number" name="rsrp_range2_max" placeholder="Max %" step="0.01"
                            class="form-control form-control-sm" form="rsrpFilterForm">
                        </div>
                      </div>
                    </div>
                  </th>
                  <th>
                    <div class="text-center">RSRP Range 3 (-110~-115dBm) %</div>
                    <div class="mt-2">
                      <div class="row g-1">
                        <div class="col-6">
                          <input type="number" name="rsrp_range3_min" placeholder="Min %" step="0.01"
                            class="form-control form-control-sm" form="rsrpFilterForm">
                        </div>
                        <div class="col-6">
                          <input type="number" name="rsrp_range3_max" placeholder="Max %" step="0.01"
                            class="form-control form-control-sm" form="rsrpFilterForm">
                        </div>
                      </div>
                    </div>
                  </th>
                  <th>
                    <div class="text-center">RSRP < -115dBm %</div>
                        <div class="mt-2">
                          <div class="row g-1">
                            <div class="col-6">
                              <input type="number" name="rsrp_range4_min" placeholder="Min %" step="0.01"
                                class="form-control form-control-sm" form="rsrpFilterForm">
                            </div>
                            <div class="col-6">
                              <input type="number" name="rsrp_range4_max" placeholder="Max %" step="0.01"
                                class="form-control form-control-sm" form="rsrpFilterForm">
                            </div>
                          </div>
                        </div>
                  </th>
                </tr>
              </thead>
              <tbody id="rsrpTableBody">
                {% if result and result['RSRP Data'] %}
                {% set grouped_rsrp = {} %}
                {% for row in result['RSRP Data'] %}
                {% set site_name = row['Site_Name'] %}
                {% set site_id = row['Site_ID'] %}
                {% if site_name not in grouped_rsrp %}
                {% set _ = grouped_rsrp.update({site_name: {}}) %}
                {% endif %}
                {% if site_id not in grouped_rsrp[site_name] %}
                {% set _ = grouped_rsrp[site_name].update({site_id: []}) %}
                {% endif %}
                {% set _ = grouped_rsrp[site_name][site_id].append(row) %}
                {% endfor %}

                {% for site_name, site_id_groups in grouped_rsrp.items() %}
                {% set total_site_name_rows = site_id_groups.values() | map('length') | sum %}
                {% set site_name_row_index = [0] %}
                {% for site_id, site_id_rows in site_id_groups.items() %}
                {% for row in site_id_rows %}
                <tr class="rsrp-row">
                  {% if site_name_row_index[0] == 0 %}
                  <td rowspan="{{ total_site_name_rows }}" class="rsrp-site-cell">{{ site_name }}</td>
                  {% endif %}
                  {% if loop.index == 1 %}
                  <td rowspan="{{ site_id_rows|length }}" class="rsrp-site-id-cell">{{ site_id }}</td>
                  {% endif %}
                  <td>{{ row['Cell_Name'] }}</td>
                  <td>{{ row['RSRP Range 1 (>-105dBm) %'] }}%</td>
                  <td>{{ row['RSRP Range 2 (-105~-110dBm) %'] }}%</td>
                  <td>{{ row['RSRP Range 3 (-110~-115dBm) %'] }}%</td>
                  <td>{{ row['RSRP < -115dBm %'] }}%</td>
                </tr>
                {% set _ = site_name_row_index.append(site_name_row_index.pop() + 1) %}
                {% endfor %}
                {% endfor %}
                {% endfor %}
                {% else %}
                <tr>
                  <td colspan="7" class="text-center text-muted">No RSRP data available for this MSISDN</td>
                </tr>
                {% endif %}
              </tbody>
            </table>
            <div id="rsrpStatus" class="text-muted small"></div>
          </div>

          <!-- Common Locations RSRP Data -->
          {% if result["Common Cell Locations"] %}
          <div class="mt-5">
            <h5 class="mb-3">RSRP for Common Location</h5>

            {% for loc in result["Common Cell Locations"] %}
            {% set loc_rsrp_data = loc.get('RSRP_DATA', []) %}

            {% if loc_rsrp_data %}
            <div class="card-body">
              <!-- RSRP Filtering Controls for common locations-->
              <div class="row mb-3">
                <div class="col-md-12">
                  <div class="bg-light p-3 rounded">
                    <form class="common-rsrp-filter-form" data-location="{{ loop.index }}">
                      <input type="hidden" name="msisdn" value="{{ result['MSISDN'] }}">
                      <input type="hidden" name="cell_code" value="{{ loc.CELL_CODE }}">
                      <div class="row g-2 mb-2">
                        <div class="col-md-2">
                          <input type="text" name="cell_name_filter" placeholder="Filter by Cell Name..."
                            class="form-control form-control-sm">
                        </div>
                        <div class="col-md-3">
                          <select name="sort_by" class="form-select form-select-sm">
                            <option value="">Sort by...</option>
                            <option value="Cell_Name">Cell Name</option>
                            <option value="Site_ID">Site ID</option>
                            <option value="Site_Name">Site Name</option>
                            <option value="RSRP Range 1 (>-105dBm) %">RSRP Range 1</option>
                            <option value="RSRP Range 2 (-105~-110dBm) %">RSRP Range 2</option>
                            <option value="RSRP Range 3 (-110~-115dBm) %">RSRP Range 3</option>
                            <option value="RSRP < -115dBm %">RSRP < -115dBm</option>
                          </select>
                        </div>
                        <div class="col-md-2">
                          <select name="sort_order" class="form-select form-select-sm">
                            <option value="asc">Ascending</option>
                            <option value="desc">Descending</option>
                          </select>
                        </div>
                        <div class="col-md-3">
                          <button type="button" onclick="applyCommonLocationRsrpFilters(this)" data-location-index="{{ loop.index }}" class="btn btn-primary btn-sm">Apply Filters</button>
                          <button type="button" onclick="clearCommonLocationRsrpFilters(this)" data-location-index="{{ loop.index }}" class="btn btn-secondary btn-sm">Clear Filters</button>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <!-- RSRP Table for common location -->
              <div class="table-responsive">
                <table class="table table-bordered" id="commonRsrpTable{{ loop.index }}">
                  <thead>
                    <tr>
                      <th>Site Name</th>
                      <th>Site ID</th>
                      <th>Cell Name</th>
                      <th>
                        <div class="text-center">RSRP Range 1 (>-105dBm) %</div>
                        <div class="mt-2">
                          <div class="row g-1">
                            <div class="col-6">
                              <input type="number" name="rsrp_range1_min" placeholder="Min %" step="0.01"
                                class="form-control form-control-sm" data-location="{{ loop.index }}">
                            </div>
                            <div class="col-6">
                              <input type="number" name="rsrp_range1_max" placeholder="Max %" step="0.01"
                                class="form-control form-control-sm" data-location="{{ loop.index }}">
                            </div>
                          </div>
                        </div>
                      </th>
                      <th>
                        <div class="text-center">RSRP Range 2 (-105~-110dBm) %</div>
                        <div class="mt-2">
                          <div class="row g-1">
                            <div class="col-6">
                              <input type="number" name="rsrp_range2_min" placeholder="Min %" step="0.01"
                                class="form-control form-control-sm" data-location="{{ loop.index }}">
                            </div>
                            <div class="col-6">
                              <input type="number" name="rsrp_range2_max" placeholder="Max %" step="0.01"
                                class="form-control form-control-sm" data-location="{{ loop.index }}">
                            </div>
                          </div>
                        </div>
                      </th>
                      <th>
                        <div class="text-center">RSRP Range 3 (-110~-115dBm) %</div>
                        <div class="mt-2">
                          <div class="row g-1">
                            <div class="col-6">
                              <input type="number" name="rsrp_range3_min" placeholder="Min %" step="0.01"
                                class="form-control form-control-sm" data-location="{{ loop.index }}">
                            </div>
                            <div class="col-6">
                              <input type="number" name="rsrp_range3_max" placeholder="Max %" step="0.01"
                                class="form-control form-control-sm" data-location="{{ loop.index }}">
                            </div>
                          </div>
                        </div>
                      </th>
                      <th>
                        <div class="text-center">RSRP < -115dBm %</div>
                            <div class="mt-2">
                              <div class="row g-1">
                                <div class="col-6">
                                  <input type="number" name="rsrp_range4_min" placeholder="Min %" step="0.01"
                                    class="form-control form-control-sm" data-location="{{ loop.index }}">
                                </div>
                                <div class="col-6">
                                  <input type="number" name="rsrp_range4_max" placeholder="Max %" step="0.01"
                                    class="form-control form-control-sm" data-location="{{ loop.index }}">
                                </div>
                              </div>
                            </div>
                      </th>
                    </tr>
                  </thead>
                  <tbody id="commonRsrpTableBody{{ loop.index }}">
                    {% set grouped_rsrp = {} %}
                    {% for row in loc_rsrp_data %}
                    {% set site_name = row['Site_Name'] %}
                    {% set site_id = row['Site_ID'] %}
                    {% if site_name not in grouped_rsrp %}
                    {% set _ = grouped_rsrp.update({site_name: {}}) %}
                    {% endif %}
                    {% if site_id not in grouped_rsrp[site_name] %}
                    {% set _ = grouped_rsrp[site_name].update({site_id: []}) %}
                    {% endif %}
                    {% set _ = grouped_rsrp[site_name][site_id].append(row) %}
                    {% endfor %}

                    {% for site_name, site_id_groups in grouped_rsrp.items() %}
                    {% set total_site_name_rows = site_id_groups.values() | map('length') | sum %}
                    {% set site_name_row_index = [0] %}
                    {% for site_id, site_id_rows in site_id_groups.items() %}
                    {% for row in site_id_rows %}
                    <tr class="rsrp-row">
                      {% if site_name_row_index[0] == 0 %}
                      <td rowspan="{{ total_site_name_rows }}" class="rsrp-site-cell">{{ site_name }}</td>
                      {% endif %}
                      {% if loop.index == 1 %}
                      <td rowspan="{{ site_id_rows|length }}" class="rsrp-site-id-cell">{{ site_id }}</td>
                      {% endif %}
                      <td>{{ row['Cell_Name'] }}</td>
                      <td>{{ row['RSRP Range 1 (>-105dBm) %'] }}%</td>
                      <td>{{ row['RSRP Range 2 (-105~-110dBm) %'] }}%</td>
                      <td>{{ row['RSRP Range 3 (-110~-115dBm) %'] }}%</td>
                      <td>{{ row['RSRP < -115dBm %'] }}%</td>
                    </tr>
                    {% set _ = site_name_row_index.append(site_name_row_index.pop() + 1) %}
                    {% endfor %}
                    {% endfor %}
                    {% endfor %}
                  </tbody>
                </table>
                <div id="commonRsrpStatus{{ loop.index }}" class="text-muted small"></div>
              </div>
              {% else %}
              <div class="card-body">
                <p class="text-muted mb-0">No RSRP data available for this location</p>
              </div>
              {% endif %}
              {% endfor %}
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <script>
      const usage = JSON.parse('{{ result["Monthly Usage"] | tojson | safe }}');

      // Line Chart (by network type)
      const networkTraces = ["2G", "3G", "4G", "5G"].map((net) => ({
        x: usage.months,
        y: usage[net].map(mb => +(mb / 1024).toFixed(2)),
        name: net,
        mode: "lines+markers",
        type: "scatter",
      }));

      const networkLayout = {
        title: "Monthly Data Volume by Network",
        xaxis: { title: "Month" },
        yaxis: { title: "Volume (GB)", tickformat: '.2f' },
      };

      Plotly.newPlot("monthlyVolumeChart", networkTraces, networkLayout, {
        responsive: true,
      });

      // Bar Chart (total usage)
      const totalBarTrace = {
        x: usage.months,
        y: usage.Total.map(mb => +(mb / 1024).toFixed(2)),
        name: "Total Usage",
        type: "bar",
        marker: { color: "#007bff" },
        width: 0.5,
      };

      const totalLayout = {
        title: "Total Monthly Data Usage",
        xaxis: { title: "Month" },
        yaxis: { title: "Total Volume (GB)", tickformat: '.2f' },
      };

      Plotly.newPlot("totalVolumeChart", [totalBarTrace], totalLayout, {
        responsive: true,
      });

      // Voice Usage Chart
      const voiceTraces = ["incoming_voice", "outgoing_voice"].map((type) => ({
        x: usage.months,
        y: usage[type],
        name: type === "incoming_voice" ? "Incoming Voice" : "Outgoing Voice",
        mode: "lines+markers",
        type: "scatter",
      }));

      const voiceLayout = {
        title: "Monthly Voice Usage",
        xaxis: { title: "Month" },
        yaxis: { title: "Voice Usage (Minutes)" },
      };

      Plotly.newPlot("voiceUsageChart", voiceTraces, voiceLayout, {
        responsive: true,
      });

      //SMS Usage Chart
      const smsTraces = ["incoming_sms", "outgoing_sms"].map((type) => ({
        x: usage.months,
        y: usage[type],
        name: type === "incoming_sms" ? "Incoming SMS" : "Outgoing SMS",
        mode: "lines+markers",
        type: "scatter",
      }));

      const smsLayout = {
        title: "Monthly SMS Usage",
        xaxis: { title: "Month" },
        yaxis: { title: "SMS Count" },
      };

      Plotly.newPlot("smsUsageChart", smsTraces, smsLayout, {
        responsive: true,
      });
    </script>

    <!-- RSRP Filtering JavaScript -->
    <script>
      function applyRsrpFilters() {
        const form = document.getElementById('rsrpFilterForm');
        const formData = new FormData(form);

        // Add values from table header inputs (they have form="rsrpFilterForm" attribute)
        const headerInputs = document.querySelectorAll('input[form="rsrpFilterForm"]');
        headerInputs.forEach(input => {
          if (input.value.trim()) {
            formData.set(input.name, input.value);
          }
        });

        fetch('/filter_rsrp_data', {
          method: 'POST',
          body: formData
        })
          .then(response => response.json())
          .then(data => {
            if (data.error) {
              alert('Error: ' + data.error);
              return;
            }

            updateRsrpTable(data.data);
            updateRsrpStatus(data.filtered_count, data.total_count);
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error filtering RSRP data');
          });
      }

      function clearRsrpFilters() {
        const form = document.getElementById('rsrpFilterForm');
        const inputs = form.querySelectorAll('input[type="text"], input[type="number"], select');
        inputs.forEach(input => {
          if (input.name !== 'msisdn') {
            input.value = '';
          }
        });

        // Also clear inputs in table headers (they have form="rsrpFilterForm" attribute)
        const headerInputs = document.querySelectorAll('input[form="rsrpFilterForm"]');
        headerInputs.forEach(input => {
          input.value = '';
        });

        // Reset to original data
        location.reload();
      }

      function updateRsrpTable(data) {
        const tbody = document.getElementById('rsrpTableBody');
        tbody.innerHTML = '';

        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No RSRP data matches the current filters</td></tr>';
          return;
        }

        // Group data by Site Name, then by Site ID
        const groupedData = {};
        data.forEach(row => {
          const siteName = row['Site_Name'];
          const siteId = row['Site_ID'];

          if (!groupedData[siteName]) {
            groupedData[siteName] = {};
          }
          if (!groupedData[siteName][siteId]) {
            groupedData[siteName][siteId] = [];
          }
          groupedData[siteName][siteId].push(row);
        });

        // Create table rows with merged Site Name and Site ID cells
        Object.keys(groupedData).forEach(siteName => {
          const siteNameGroups = groupedData[siteName];
          const totalSiteNameRows = Object.values(siteNameGroups).reduce((sum, arr) => sum + arr.length, 0);
          let siteNameRowIndex = 0;

          Object.keys(siteNameGroups).forEach(siteId => {
            const siteIdRows = siteNameGroups[siteId];

            siteIdRows.forEach((row, cellIndex) => {
              const tr = document.createElement('tr');
              tr.className = 'rsrp-row';

              let html = '';

              // Only show Site Name in the first row for this site name
              if (siteNameRowIndex === 0) {
                html += `<td rowspan="${totalSiteNameRows}" class="rsrp-site-cell">${siteName}</td>`;
              }

              // Only show Site ID in the first row for this site ID
              if (cellIndex === 0) {
                html += `<td rowspan="${siteIdRows.length}" class="rsrp-site-id-cell">${siteId}</td>`;
              }

              html += `
              <td>${row['Cell_Name']}</td>
              <td>${row['RSRP Range 1 (>-105dBm) %']}%</td>
              <td>${row['RSRP Range 2 (-105~-110dBm) %']}%</td>
              <td>${row['RSRP Range 3 (-110~-115dBm) %']}%</td>
              <td>${row['RSRP < -115dBm %']}%</td>
            `;

              tr.innerHTML = html;
              tbody.appendChild(tr);
              siteNameRowIndex++;
            });
          });
        });
      }

      function updateRsrpStatus(filteredCount, totalCount) {
        const statusDiv = document.getElementById('rsrpStatus');
        if (filteredCount < totalCount) {
          statusDiv.textContent = `Showing ${filteredCount} of ${totalCount} RSRP records (filtered)`;
        } else {
          statusDiv.textContent = `Showing all ${totalCount} RSRP records`;
        }
      }

      // Common Location RSRP Filtering Functions
      function applyCommonLocationRsrpFilters(buttonElement) {
        const locationIndex = buttonElement.getAttribute('data-location-index');
        const form = document.querySelector(`form.common-rsrp-filter-form[data-location="${locationIndex}"]`);
        const formData = new FormData(form);

        // Add the site ID from the form's hidden input
        const cellCode = formData.get('cell_code');
        if (cellCode) {
          formData.set('site_id', cellCode.substring(0, 6)); // First 6 characters
        }

        // Add values from table header inputs for this location
        const headerInputs = document.querySelectorAll(`input[data-location="${locationIndex}"]`);
        headerInputs.forEach(input => {
          if (input.value.trim()) {
            formData.set(input.name, input.value);
          }
        });

        fetch('/filter_common_location_rsrp_data', {
          method: 'POST',
          body: formData
        })
          .then(response => response.json())
          .then(data => {
            if (data.error) {
              alert('Error: ' + data.error);
              return;
            }

            updateCommonLocationRsrpTable(locationIndex, data.data);
            updateCommonLocationRsrpStatus(locationIndex, data.filtered_count, data.total_count);
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error filtering RSRP data');
          });
      }

      function clearCommonLocationRsrpFilters(buttonElement) {
        const locationIndex = buttonElement.getAttribute('data-location-index');
        const form = document.querySelector(`form.common-rsrp-filter-form[data-location="${locationIndex}"]`);
        const inputs = form.querySelectorAll('input[type="text"], input[type="number"], select');
        inputs.forEach(input => {
          if (input.name !== 'msisdn' && input.name !== 'cell_code') {
            input.value = '';
          }
        });

        // Also clear inputs in table headers for this location
        const headerInputs = document.querySelectorAll(`input[data-location="${locationIndex}"]`);
        headerInputs.forEach(input => {
          input.value = '';
        });

        // Reset to original data
        location.reload();
      }

      function updateCommonLocationRsrpTable(locationIndex, data) {
        const tbody = document.getElementById(`commonRsrpTableBody${locationIndex}`);
        tbody.innerHTML = '';

        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No RSRP data matches the current filters</td></tr>';
          return;
        }

        // Group data by Site Name, then by Site ID
        const groupedData = {};
        data.forEach(row => {
          const siteName = row['Site_Name'];
          const siteId = row['Site_ID'];

          if (!groupedData[siteName]) {
            groupedData[siteName] = {};
          }
          if (!groupedData[siteName][siteId]) {
            groupedData[siteName][siteId] = [];
          }
          groupedData[siteName][siteId].push(row);
        });

        // Create table rows with merged Site Name and Site ID cells
        Object.keys(groupedData).forEach(siteName => {
          const siteNameGroups = groupedData[siteName];
          const totalSiteNameRows = Object.values(siteNameGroups).reduce((sum, arr) => sum + arr.length, 0);
          let siteNameRowIndex = 0;

          Object.keys(siteNameGroups).forEach(siteId => {
            const siteIdRows = siteNameGroups[siteId];

            siteIdRows.forEach((row, cellIndex) => {
              const tr = document.createElement('tr');
              tr.className = 'rsrp-row';

              let html = '';

              // Only show Site Name in the first row for this site name
              if (siteNameRowIndex === 0) {
                html += `<td rowspan="${totalSiteNameRows}" class="rsrp-site-cell">${siteName}</td>`;
              }

              // Only show Site ID in the first row for this site ID
              if (cellIndex === 0) {
                html += `<td rowspan="${siteIdRows.length}" class="rsrp-site-id-cell">${siteId}</td>`;
              }

              html += `
              <td>${row['Cell_Name']}</td>
              <td>${row['RSRP Range 1 (>-105dBm) %']}%</td>
              <td>${row['RSRP Range 2 (-105~-110dBm) %']}%</td>
              <td>${row['RSRP Range 3 (-110~-115dBm) %']}%</td>
              <td>${row['RSRP < -115dBm %']}%</td>
            `;

              tr.innerHTML = html;
              tbody.appendChild(tr);
              siteNameRowIndex++;
            });
          });
        });
      }

      function updateCommonLocationRsrpStatus(locationIndex, filteredCount, totalCount) {
        const statusDiv = document.getElementById(`commonRsrpStatus${locationIndex}`);
        if (filteredCount < totalCount) {
          statusDiv.textContent = `Showing ${filteredCount} of ${totalCount} RSRP records (filtered)`;
        } else {
          statusDiv.textContent = `Showing all ${totalCount} RSRP records`;
        }
      }
    </script>

    {% elif error %}
    <div class="container mt-4">
      <div class="alert alert-danger"><strong>Error:</strong> {{ error }}</div>
    </div>
    {% endif %}

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
</body>

</html>