<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>MSISDN Information</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    .tab-content {
      margin-top: 20px;
      height: 200px;
    }

    .logout-btn {
      position: absolute;
      top: 20px;
      right: 20px;
    }

    .map-preview {
      height: 300px;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
    }



    /* Simple Table Styling */
    .table th input.form-control-sm {
      font-size: 0.75rem;
      padding: 4px 6px;
      height: 28px;
    }

    /* Unified RSRP Table Styling */
    .rsrp-table {
      table-layout: fixed;
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    .rsrp-table th,
    .rsrp-table td {
      word-wrap: break-word;
      white-space: normal;
      vertical-align: middle;
      padding: 8px 6px;
      border: 1px solid #dee2e6;
    }

    /* Header styling */
    .rsrp-table thead th {
      background-color: #6c757d;
      color: white;
      text-align: center;
      font-weight: 600;
      vertical-align: top;
      padding: 10px 6px;
    }

    .rsrp-table thead th div {
      text-align: center;
    }

    .rsrp-table thead th input.form-control-sm {
      font-size: 0.7rem;
      padding: 2px 4px;
      height: auto;
      width: 100%;
      box-sizing: border-box;
    }

    /* Fixed column widths */
    .rsrp-table th:nth-child(1),
    .rsrp-table td:nth-child(1) {
      width: 140px;
      min-width: 140px;
      max-width: 140px;
    }

    .rsrp-table th:nth-child(2),
    .rsrp-table td:nth-child(2) {
      width: 100px;
      min-width: 100px;
      max-width: 100px;
    }

    .rsrp-table th:nth-child(3),
    .rsrp-table td:nth-child(3) {
      width: 160px;
      min-width: 160px;
      max-width: 160px;
    }

    .rsrp-table th:nth-child(4),
    .rsrp-table th:nth-child(5),
    .rsrp-table th:nth-child(6),
    .rsrp-table th:nth-child(7),
    .rsrp-table td:nth-child(4),
    .rsrp-table td:nth-child(5),
    .rsrp-table td:nth-child(6),
    .rsrp-table td:nth-child(7) {
      width: 120px;
      min-width: 120px;
      max-width: 120px;
    }

    /* Site Name column styling */
    .rsrp-site-cell {
      background-color: #f8f9fa;
      font-weight: bold;
      border-right: 2px solid #dee2e6;
    }

    /* Site ID column styling */
    .rsrp-site-id-cell {
      background-color: #e9ecef;
      font-weight: 600;
      border-right: 1px solid #dee2e6;
    }

    /* Cell Name column styling */
    .rsrp-cell-name {
      background-color: #ffffff;
    }

    /* Data columns styling */
    .rsrp-data-cell {
      background-color: #ffffff;
      text-align: center;
    }

    /* Hover effects */
    .rsrp-table tbody tr:hover {
      background-color: #f8f9fa;
      transition: background-color 0.15s ease-in-out;
    }

    .rsrp-table tbody tr:hover .rsrp-site-cell {
      background-color: #e9ecef;
    }

    .rsrp-table tbody tr:hover .rsrp-site-id-cell {
      background-color: #dee2e6;
    }

    /* RSRP section styling */
    .rsrp-section {
      margin-bottom: 2rem;
    }

    .rsrp-section h5 {
      color: #495057;
      font-weight: 600;
      border-bottom: 2px solid #dee2e6;
      padding-bottom: 0.5rem;
      margin-bottom: 1.5rem;
    }

    /* Filter controls styling */
    .rsrp-filter-controls {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }

    .rsrp-filter-controls .form-control-sm,
    .rsrp-filter-controls .form-select-sm {
      font-size: 0.8rem;
      height: 32px;
    }

    /* Status text */
    .rsrp-status {
      margin-top: 0.75rem;
      font-size: 0.85rem;
      color: #6c757d;
    }

    /* Table responsive wrapper */
    .table-responsive {
      overflow-x: auto;
      margin-bottom: 1rem;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .rsrp-table {
        font-size: 0.75rem;
      }
      
      .rsrp-table th:nth-child(1),
      .rsrp-table td:nth-child(1) {
        width: 120px;
        min-width: 120px;
        max-width: 120px;
      }

      .rsrp-table th:nth-child(2),
      .rsrp-table td:nth-child(2) {
        width: 80px;
        min-width: 80px;
        max-width: 80px;
      }

      .rsrp-table th:nth-child(3),
      .rsrp-table td:nth-child(3) {
        width: 130px;
        min-width: 130px;
        max-width: 130px;
      }

      .rsrp-table th:nth-child(4),
      .rsrp-table th:nth-child(5),
      .rsrp-table th:nth-child(6),
      .rsrp-table th:nth-child(7),
      .rsrp-table td:nth-child(4),
      .rsrp-table td:nth-child(5),
      .rsrp-table td:nth-child(6),
      .rsrp-table td:nth-child(7) {
        width: 100px;
        min-width: 100px;
        max-width: 100px;
      }
    }





    /* Range Filter Styling */
    .range-filter-group {
      border: 1px solid #e9ecef;
      border-radius: 6px;
      padding: 8px;
      background-color: #f8f9fa;
    }

    .range-filter-group label {
      font-weight: 600;
      color: #495057;
    }

    .legacy-filters {
      border-top: 1px solid #dee2e6;
      padding-top: 12px;
      margin-top: 8px;
    }

    .card-header h6 {
      margin-bottom: 2px;
    }
  </style>
</head>

<body>
  <div class="container mt-5">
    <a href="{{ url_for('logout') }}" class="btn btn-outline-danger logout-btn">
      Logout
    </a>
    <div class="col-md-6 offset-md-3">
      <div class="card p-4 shadow-sm">
        <h2 class="mb-4">Enter MSISDN to Retrieve Information</h2>
        <form action="/search" method="POST">
          <div class="mb-3">
            <label for="msisdn" class="form-label">MSISDN</label>
            <input type="text" class="form-control" id="msisdn" name="msisdn" required />
          </div>
          <button type="submit" class="btn btn-primary w-100">Search</button>
        </form>
      </div>
    </div>
  </div>

  {% if result %}
  <div class="container-fluid px-4 mt-4">
    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs" id="infoTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button"
          role="tab" aria-controls="details" aria-selected="true">
          Details
        </button>
      </li>
      <!-- NEW MAP TAB - ADDED -->
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="location-tab" data-bs-toggle="tab" data-bs-target="#location" type="button"
          role="tab" aria-controls="location" aria-selected="false">
          Location Map
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="graphs-tab" data-bs-toggle="tab" data-bs-target="#graphs" type="button" role="tab"
          aria-controls="graphs" aria-selected="false">
          Usage Graphs
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="rsrp-tab" data-bs-toggle="tab" data-bs-target="#rsrp" type="button" role="tab"
          aria-controls="rsrp" aria-selected="false">
          RSRP Data
        </button>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="infoTabsContent">
      <div class="tab-pane fade show active" id="details" role="tabpanel" aria-labelledby="details-tab">
        <div class="card p-4 mt-3">
          1. Subscriber Identification
          <table class="table table-bordered">
            <tr>
              <td><strong>MSISDN:</strong></td>
              <td>{{ result['MSISDN'] }}</td>
            </tr>
            <tr>
              <td><strong>IMSI:</strong></td>
              <td>{{ result['IMSI'] }}</td>
            </tr>
            <tr>
              <td><strong>IMEI:</strong></td>
              <td>{{ result['IMEI']}}</td>
            </tr>
          </table>

          <br>
          2. Device Information
          <table class="table table-bordered">
            <tr>
              <td><strong>Device Manufacturer:</strong></td>
              <td>{{ result['Brand']}}</td>
            </tr>
            <tr>
              <td><strong>Model</strong></td>
              <td>{{ result['Model'] }}</td>
            </tr>
            <tr>
              <td><strong>Device Type</strong></td>
              <td>{{ result['Device Type'] }}</td>
            </tr>
            <tr>
              <td><strong>Primary Hardware Type</strong></td>
              <td>{{ result['Primary Hardware Type'] }}</td>
            </tr>
            <tr>
              <td><strong>Year Released</strong></td>
              <td>{{ result['Year Released'] }}</td>
            </tr>
            <tr>
              <td><strong>Operating System Version</strong></td>
              <td>{{ result['OS'] }}</td>
            </tr>
            <tr>
              <td><strong>VoLTE Support</strong></td>
              <td>{{ result['VoLTE'] }}</td>
            </tr>
            <tr>
              <td><strong>SIM Type</strong></td>
              <td>{{ result['SIM Type'] }}</td>
            </tr>
            <tr>
              <td><strong>VoLTE-provisioning Status</strong></td> <!---->
            </tr>
          </table>
          <br>

          3. Location Data
          <table class="table table-bordered">
            <tr>
              <td>Recent Cell Location</td>
            </tr>
            <tr>
              <td><strong>Cell Code:</strong></td>
              <td>{{ result['Cellcode'] }}</td>
            </tr>
            <tr>
              <td><strong>Site Name:</strong></td>
              <td>{{ result['Sitename'] }}</td>
            </tr>
            <tr>
              <td><strong>Coordinates:</strong></td>
              <td>Lat: {{ result['Lat'] }}, Lon: {{ result['Lon'] }}</td>
            </tr>
            <tr>
              <td><strong>Region:</strong></td>
              <td>{{ result['Region'] }}</td>
            </tr>
            <tr>
              <td><strong>District:</strong></td>
              <td>{{ result['District'] }}</td>
            </tr>
            <tr>
              <td><strong>LAC:</strong></td>
              <td>{{ result['LAC'] }}</td>
            </tr>
            <tr>
              <td><strong>Cell_ID:</strong></td>
              <td>{{ result['SAC'] }}</td>
            </tr>
            {% if result["Common Cell Locations"] %}
            {% for loc in result["Common Cell Locations"] %}
            <tr>
              <td>Common Cell Location</td>
            </tr>
            <tr>
              <td><strong>Cell Code</strong></td>
              <td>{{ loc.CELL_CODE }}</td>
            </tr>
            <tr>
              <td><strong>Site Name</strong></td>
              <td>{{ loc.SITE_NAME }}</td>
            </tr>
            <tr>
              <td><strong>Coordinates:</strong></td>
              <td>
                {% if loc.LAT and loc.LON and loc.LAT != 'Not Found' and loc.LON != 'Not Found' %}
                Lat: {{ loc.LAT }}, Lon: {{ loc.LON }}
                {% else %}
                Not Available
                {% endif %}
              </td>
            </tr>
            <tr>
              <td><strong>District</strong></td>
              <td>{{ loc.DISTRICT }}</td>
            </tr>
            <tr>
              <td><strong>LAC</strong></td>
              <td>{{ loc.LAC }}</td>
            </tr>
            <tr>
              <td><strong>Cell_ID</strong></td>
              <td>{{ loc.CELL }}</td>
            </tr>
            {% if not loop.last %}
            <tr>
              <td colspan="2" style="border-top: 2px solid #dee2e6;"></td>
            </tr>
            {% endif %}
            {% endfor %}
            {% else %}
            <tr>
              <td><strong>Common Locations:</strong></td>
              <td class="text-muted">No common locations found for this MSISDN.</td>
            </tr>
            {% endif %}
          </table>

          <br>
        </div>
      </div>

      <!-- Location Map Tab Content-->
      <div class="tab-pane fade" id="location" role="tabpanel" aria-labelledby="location-tab">
        <div class="card p-4 mt-3">
          <div class="map-preview mb-3">
            {% if has_map %}
            <iframe src="{{ url_for('static', filename='temp_map.html') }}" width="100%" height="100%"
              frameborder="0"></iframe>
            {% else %}
            <div class="d-flex align-items-center justify-content-center h-100 bg-light">
              <div class="text-center">
                <p class="mb-2">Other regions map preview not available</p>
                <small class="text-muted">Click "View Other Regions Map" to explore</small>
              </div>
            </div>
            {% endif %}
          </div>

          <div class="d-flex gap-2 flex-wrap">
            <a href="{{ url_for('show_map', msisdn=result.MSISDN) }}" class="btn btn-success" target="_blank">
              View Full Map
            </a>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="graphs" role="tabpanel" aria-labelledby="graphs-tab">
        <div class="row mt-3">
          <!-- Line Chart -->
          <div class="col-md-6 mb-4">
            <div class="card border p-3">
              <div id="monthlyVolumeChart" style="width: 100%; height: 400px"></div>
            </div>
          </div>

          <!-- Bar Chart -->
          <div class="col-md-6 mb-4">
            <div class="card border p-3">
              <div id="totalVolumeChart" style="width: 100%; height: 400px"></div>
            </div>
          </div>
          <!-- Voice Usage Chart -->
          <div class="col-md-6 mb-4">
            <div class="card border p-3">
              <div id="voiceUsageChart" style="width: 100%; height: 400px"></div>
            </div>
          </div>
          <!--SMS Usage Chart-->
          <div class="col-md-6 mb-4">
            <div class="card border p-3">
              <div id="smsUsageChart" style="width: 100%; height: 400px"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- RSRP Data Tab Content -->
      <div class="tab-pane fade" id="rsrp" role="tabpanel" aria-labelledby="rsrp-tab">
        <div class="card p-4 mt-3">
          <div class="rsrp-section">
            <h5 class="mb-3">RSRP for Recent Location</h5>            <!-- RSRP Filtering Controls -->
            <div class="row mb-3">
              <div class="col-md-12">
                <div class="rsrp-filter-controls">
                  <form id="rsrpFilterForm">
                  <input type="hidden" name="msisdn" value="{{ result['MSISDN'] }}">
                  <div class="row g-2 mb-2">
                    <div class="col-md-2">
                      <input type="text" name="cell_name_filter" placeholder="Filter by Cell Name..."
                        class="form-control form-control-sm"
                        oninput="debounceRsrpFilter()"
                        onkeyup="debounceRsrpFilter()">
                    </div>
                    <div class="col-md-2">
                      <select name="sort_by" class="form-select form-select-sm" onchange="debounceRsrpFilter()">
                        <option value="">Sort by...</option>
                        <!-- <option value="Site_Name">Site Name</option> -->
                        <option value="Cell_Name">Cell Name</option>
                        <option value="RSRP Range 1 (>-105dBm) %">RSRP Range 1</option>
                        <option value="RSRP Range 2 (-105~-110dBm) %">RSRP Range 2</option>
                        <option value="RSRP Range 3 (-110~-115dBm) %">RSRP Range 3</option>
                        <option value="RSRP < -115dBm %">RSRP < -115dBm</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <select name="sort_order" class="form-select form-select-sm" onchange="debounceRsrpFilter()">
                        <option value="asc">Ascending</option>
                        <option value="desc">Descending</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <button type="button" onclick="clearRsrpFilters()" class="btn btn-secondary btn-sm">Clear Filters</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- RSRP Table -->
          <div class="table-responsive">
            <table class="table table-bordered rsrp-table" id="rsrpTable">
              <thead>
                <tr>
                  <th>Site Name</th>
                  <th>Site ID</th>
                  <th>Cell Name</th>
                  <th>
                    <div class="text-center">RSRP Range 1 (>-105dBm) %</div>
                    <div class="mt-2">
                      <div class="row g-1">
                        <div class="col-6">
                          <input type="number" name="rsrp_range1_min" placeholder="Min %" step="0.01"
                            class="form-control form-control-sm" form="rsrpFilterForm"
                            oninput="debounceRsrpFilter()">
                        </div>
                        <div class="col-6">
                          <input type="number" name="rsrp_range1_max" placeholder="Max %" step="0.01"
                            class="form-control form-control-sm" form="rsrpFilterForm"
                            oninput="debounceRsrpFilter()">
                        </div>
                      </div>
                    </div>
                  </th>
                  <th>
                    <div class="text-center">RSRP Range 2 (-105~-110dBm) %</div>
                    <div class="mt-2">
                      <div class="row g-1">
                        <div class="col-6">
                          <input type="number" name="rsrp_range2_min" placeholder="Min %" step="0.01"
                            class="form-control form-control-sm" form="rsrpFilterForm"
                            oninput="debounceRsrpFilter()">
                        </div>
                        <div class="col-6">
                          <input type="number" name="rsrp_range2_max" placeholder="Max %" step="0.01"
                            class="form-control form-control-sm" form="rsrpFilterForm"
                            oninput="debounceRsrpFilter()">
                        </div>
                      </div>
                    </div>
                  </th>
                  <th>
                    <div class="text-center">RSRP Range 3 (-110~-115dBm) %</div>
                    <div class="mt-2">
                      <div class="row g-1">
                        <div class="col-6">
                          <input type="number" name="rsrp_range3_min" placeholder="Min %" step="0.01"
                            class="form-control form-control-sm" form="rsrpFilterForm"
                            oninput="debounceRsrpFilter()">
                        </div>
                        <div class="col-6">
                          <input type="number" name="rsrp_range3_max" placeholder="Max %" step="0.01"
                            class="form-control form-control-sm" form="rsrpFilterForm"
                            oninput="debounceRsrpFilter()">
                        </div>
                      </div>
                    </div>
                  </th>
                  <th>
                    <div class="text-center">RSRP < -115dBm %</div>
                    <div class="mt-2">
                      <div class="row g-1">
                        <div class="col-6">
                          <input type="number" name="rsrp_range4_min" placeholder="Min %" step="0.01"
                            class="form-control form-control-sm" form="rsrpFilterForm"
                            oninput="debounceRsrpFilter()">
                        </div>
                        <div class="col-6">
                          <input type="number" name="rsrp_range4_max" placeholder="Max %" step="0.01"
                            class="form-control form-control-sm" form="rsrpFilterForm"
                            oninput="debounceRsrpFilter()">
                        </div>
                      </div>
                    </div>
                  </th>
                </tr>
              </thead>
              <tbody id="rsrpTableBody">
                {% if result and result['RSRP Data'] %}
                {% set grouped_rsrp = {} %}
                {% for row in result['RSRP Data'] %}
                {% set site_name = row['Site_Name'] %}
                {% set site_id = row['Site_ID'] %}
                {% if site_name not in grouped_rsrp %}
                {% set _ = grouped_rsrp.update({site_name: {}}) %}
                {% endif %}
                {% if site_id not in grouped_rsrp[site_name] %}
                {% set _ = grouped_rsrp[site_name].update({site_id: []}) %}
                {% endif %}
                {% set _ = grouped_rsrp[site_name][site_id].append(row) %}
                {% endfor %}

                {% for site_name, site_id_groups in grouped_rsrp.items() %}
                {% set total_site_name_rows = site_id_groups.values() | map('length') | sum %}
                {% set site_name_row_index = [0] %}
                {% for site_id, site_id_rows in site_id_groups.items() %}
                {% for row in site_id_rows %}
                <tr>
                  {% if site_name_row_index[0] == 0 %}
                  <td rowspan="{{ total_site_name_rows }}" class="rsrp-site-cell">{{ site_name }}</td>
                  {% endif %}
                  {% if loop.index == 1 %}
                  <td rowspan="{{ site_id_rows|length }}" class="rsrp-site-id-cell">{{ site_id }}</td>
                  {% endif %}
                  <td class="rsrp-cell-name">{{ row['Cell_Name'] }}</td>
                  <td class="rsrp-data-cell">{{ row['RSRP Range 1 (>-105dBm) %'] }}%</td>
                  <td class="rsrp-data-cell">{{ row['RSRP Range 2 (-105~-110dBm) %'] }}%</td>
                  <td class="rsrp-data-cell">{{ row['RSRP Range 3 (-110~-115dBm) %'] }}%</td>
                  <td class="rsrp-data-cell">{{ row['RSRP < -115dBm %'] }}%</td>
                </tr>
                {% set _ = site_name_row_index.append(site_name_row_index.pop() + 1) %}
                {% endfor %}
                {% endfor %}
                {% endfor %}
                {% else %}
                <tr>
                  <td colspan="7" class="text-center text-muted">No RSRP data available for this MSISDN</td>
                </tr>
                {% endif %}
              </tbody>
            </table>
            <div id="rsrpStatus" class="rsrp-status"></div>
          </div>
          </div>

          <!-- Common Locations RSRP Data -->
          {% if result["Common Cell Locations"] %}
          {% set all_common_rsrp_data = [] %}
          {% for loc in result["Common Cell Locations"] %}
            {% set loc_rsrp_data = loc.get('RSRP_DATA', []) %}
            {% for row in loc_rsrp_data %}
              {% set enhanced_row = row.copy() %}
              {% set _ = all_common_rsrp_data.append(enhanced_row) %}
            {% endfor %}
          {% endfor %}

          {% if all_common_rsrp_data %}
          <hr class="my-4">
          <div class="rsrp-section">
            <h5 class="mb-3">RSRP for Common Locations ({{ result["Common Cell Locations"]|length }} locations)</h5>

            <!-- RSRP Filtering Controls for all common locations -->
            <div class="row mb-3">
              <div class="col-md-12">
                <div class="rsrp-filter-controls">
                  <form id="commonRsrpFilterForm">
                    <input type="hidden" name="msisdn" value="{{ result['MSISDN'] }}">
                    <div class="row g-2 mb-2">
                      <div class="col-md-2">
                        <input type="text" name="cell_name_filter" placeholder="Filter by Cell Name..."
                          class="form-control form-control-sm"
                          oninput="debounceCommonRsrpFilter()"
                          onkeyup="debounceCommonRsrpFilter()">
                      </div>
                      <div class="col-md-2">
                        <input type="text" name="site_name_filter" placeholder="Filter by Site Name..."
                          class="form-control form-control-sm"
                          oninput="debounceCommonRsrpFilter()"
                          onkeyup="debounceCommonRsrpFilter()">
                      </div>
                      <div class="col-md-2">
                        <select name="sort_by" class="form-select form-select-sm" onchange="debounceCommonRsrpFilter()">
                          <option value="">Sort by...</option>
                          <option value="Site_Name">Site Name</option>
                          <option value="Cell_Name">Cell Name</option>
                          <option value="RSRP Range 1 (>-105dBm) %">RSRP Range 1</option>
                          <option value="RSRP Range 2 (-105~-110dBm) %">RSRP Range 2</option>
                          <option value="RSRP Range 3 (-110~-115dBm) %">RSRP Range 3</option>
                          <option value="RSRP < -115dBm %">RSRP < -115dBm</option>
                        </select>
                      </div>
                      <div class="col-md-2">
                        <select name="sort_order" class="form-select form-select-sm" onchange="debounceCommonRsrpFilter()">
                          <option value="asc">Ascending</option>
                          <option value="desc">Descending</option>
                        </select>
                      </div>
                      <div class="col-md-2">
                        <button type="button" onclick="clearCommonRsrpFilters()" class="btn btn-secondary btn-sm">Clear Filters</button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <!-- Unified RSRP Table for all common locations -->
            <div class="table-responsive">
              <table class="table table-bordered rsrp-table" id="commonRsrpTable">
                <thead>
                  <tr>
                    <th>Site Name</th>
                    <th>Site ID</th>
                    <th>Cell Name</th>
                    <th>
                      <div class="text-center">RSRP Range 1 (>-105dBm) %</div>
                      <div class="mt-2">
                        <div class="row g-1">
                          <div class="col-6">
                            <input type="number" name="rsrp_range1_min" placeholder="Min %" step="0.01"
                              class="form-control form-control-sm" form="commonRsrpFilterForm"
                              oninput="debounceCommonRsrpFilter()">
                          </div>
                          <div class="col-6">
                            <input type="number" name="rsrp_range1_max" placeholder="Max %" step="0.01"
                              class="form-control form-control-sm" form="commonRsrpFilterForm"
                              oninput="debounceCommonRsrpFilter()">
                          </div>
                        </div>
                      </div>
                    </th>
                    <th>
                      <div class="text-center">RSRP Range 2 (-105~-110dBm) %</div>
                      <div class="mt-2">
                        <div class="row g-1">
                          <div class="col-6">
                            <input type="number" name="rsrp_range2_min" placeholder="Min %" step="0.01"
                              class="form-control form-control-sm" form="commonRsrpFilterForm"
                              oninput="debounceCommonRsrpFilter()">
                          </div>
                          <div class="col-6">
                            <input type="number" name="rsrp_range2_max" placeholder="Max %" step="0.01"
                              class="form-control form-control-sm" form="commonRsrpFilterForm"
                              oninput="debounceCommonRsrpFilter()">
                          </div>
                        </div>
                      </div>
                    </th>
                    <th>
                      <div class="text-center">RSRP Range 3 (-110~-115dBm) %</div>
                      <div class="mt-2">
                        <div class="row g-1">
                          <div class="col-6">
                            <input type="number" name="rsrp_range3_min" placeholder="Min %" step="0.01"
                              class="form-control form-control-sm" form="commonRsrpFilterForm"
                              oninput="debounceCommonRsrpFilter()">
                          </div>
                          <div class="col-6">
                            <input type="number" name="rsrp_range3_max" placeholder="Max %" step="0.01"
                              class="form-control form-control-sm" form="commonRsrpFilterForm"
                              oninput="debounceCommonRsrpFilter()">
                          </div>
                        </div>
                      </div>
                    </th>
                    <th>
                      <div class="text-center">RSRP < -115dBm %</div>
                      <div class="mt-2">
                        <div class="row g-1">
                          <div class="col-6">
                            <input type="number" name="rsrp_range4_min" placeholder="Min %" step="0.01"
                              class="form-control form-control-sm" form="commonRsrpFilterForm"
                              oninput="debounceCommonRsrpFilter()">
                          </div>
                          <div class="col-6">
                            <input type="number" name="rsrp_range4_max" placeholder="Max %" step="0.01"
                              class="form-control form-control-sm" form="commonRsrpFilterForm"
                              oninput="debounceCommonRsrpFilter()">
                          </div>
                        </div>
                      </div>
                    </th>
                  </tr>
                </thead>
                <tbody id="commonRsrpTableBody">
                  {% set grouped_rsrp = {} %}
                  {% for row in all_common_rsrp_data %}
                    {% set site_name = row['Site_Name'] %}
                    {% set site_id = row['Site_ID'] %}
                    
                    {% if site_name not in grouped_rsrp %}
                      {% set _ = grouped_rsrp.update({site_name: {}}) %}
                    {% endif %}
                    {% if site_id not in grouped_rsrp[site_name] %}
                      {% set _ = grouped_rsrp[site_name].update({site_id: []}) %}
                    {% endif %}
                    {% set _ = grouped_rsrp[site_name][site_id].append(row) %}
                  {% endfor %}

                  {% for site_name, site_id_groups in grouped_rsrp.items() %}
                    {% set site_total_rows = [] %}
                    {% for site_id, site_id_rows in site_id_groups.items() %}
                      {% for row in site_id_rows %}
                        {% set _ = site_total_rows.append(1) %}
                      {% endfor %}
                    {% endfor %}
                    {% set site_row_count = site_total_rows|length %}
                    {% set site_name_row_index = [0] %}
                    
                    {% for site_id, site_id_rows in site_id_groups.items() %}
                      {% for row in site_id_rows %}
                      <tr>
                        {% if site_name_row_index[0] == 0 %}
                        <td rowspan="{{ site_row_count }}" class="rsrp-site-cell">{{ site_name }}</td>
                        {% endif %}
                        {% if loop.index == 1 %}
                        <td rowspan="{{ site_id_rows|length }}" class="rsrp-site-id-cell">{{ site_id }}</td>
                        {% endif %}
                        <td class="rsrp-cell-name">{{ row['Cell_Name'] }}</td>
                        <td class="rsrp-data-cell">{{ row['RSRP Range 1 (>-105dBm) %'] }}%</td>
                        <td class="rsrp-data-cell">{{ row['RSRP Range 2 (-105~-110dBm) %'] }}%</td>
                        <td class="rsrp-data-cell">{{ row['RSRP Range 3 (-110~-115dBm) %'] }}%</td>
                        <td class="rsrp-data-cell">{{ row['RSRP < -115dBm %'] }}%</td>
                      </tr>
                      {% set _ = site_name_row_index.append(site_name_row_index.pop() + 1) %}
                      {% endfor %}
                    {% endfor %}
                  {% endfor %}
                </tbody>
              </table>
              <div id="commonRsrpStatus" class="rsrp-status"></div>
            </div>
          </div>
          {% endif %}
          {% endif %}
          </div>
        </div>
        </div>
      </div>
    </div>

    <script>
      const usage = JSON.parse('{{ result["Monthly Usage"] | tojson | safe }}');

      // Line Chart (by network type)
      const networkTraces = ["2G", "3G", "4G", "5G"].map((net) => ({
        x: usage.months,
        y: usage[net].map(mb => +(mb / 1024).toFixed(2)),
        name: net,
        mode: "lines+markers",
        type: "scatter",
      }));

      const networkLayout = {
        title: "Monthly Data Volume by Network",
        xaxis: { title: "Month" },
        yaxis: { title: "Volume (GB)", tickformat: '.2f' },
      };

      Plotly.newPlot("monthlyVolumeChart", networkTraces, networkLayout, {
        responsive: true,
      });

      // Bar Chart (total usage)
      const totalBarTrace = {
        x: usage.months,
        y: usage.Total.map(mb => +(mb / 1024).toFixed(2)),
        name: "Total Usage",
        type: "bar",
        marker: { color: "#007bff" },
        width: 0.5,
      };

      const totalLayout = {
        title: "Total Monthly Data Usage",
        xaxis: { title: "Month" },
        yaxis: { title: "Total Volume (GB)", tickformat: '.2f' },
      };

      Plotly.newPlot("totalVolumeChart", [totalBarTrace], totalLayout, {
        responsive: true,
      });

      // Voice Usage Chart
      const voiceTraces = ["incoming_voice", "outgoing_voice"].map((type) => ({
        x: usage.months,
        y: usage[type],
        name: type === "incoming_voice" ? "Incoming Voice" : "Outgoing Voice",
        mode: "lines+markers",
        type: "scatter",
      }));

      const voiceLayout = {
        title: "Monthly Voice Usage",
        xaxis: { title: "Month" },
        yaxis: { title: "Voice Usage (Minutes)" },
      };

      Plotly.newPlot("voiceUsageChart", voiceTraces, voiceLayout, {
        responsive: true,
      });

      //SMS Usage Chart
      const smsTraces = ["incoming_sms", "outgoing_sms"].map((type) => ({
        x: usage.months,
        y: usage[type],
        name: type === "incoming_sms" ? "Incoming SMS" : "Outgoing SMS",
        mode: "lines+markers",
        type: "scatter",
      }));

      const smsLayout = {
        title: "Monthly SMS Usage",
        xaxis: { title: "Month" },
        yaxis: { title: "SMS Count" },
      };

      Plotly.newPlot("smsUsageChart", smsTraces, smsLayout, {
        responsive: true,
      });
    </script>

    <!-- RSRP Filtering JavaScript -->
    <script>
      let rsrpFilterTimeout;
      let commonRsrpFilterTimeout;

      function debounceRsrpFilter() {
        clearTimeout(rsrpFilterTimeout);
        rsrpFilterTimeout = setTimeout(() => {
          applyRsrpFilters();
        }, 200);
      }

      function debounceCommonRsrpFilter() {
        clearTimeout(commonRsrpFilterTimeout);
        commonRsrpFilterTimeout = setTimeout(() => {
          applyCommonRsrpFilters();
        }, 200);
      }

      function applyRsrpFilters() {
        const form = document.getElementById('rsrpFilterForm');
        const formData = new FormData(form);

        const headerInputs = document.querySelectorAll('input[form="rsrpFilterForm"]');
        headerInputs.forEach(input => {
          if (input.value.trim()) {
            formData.set(input.name, input.value);
          }
        });

        fetch('/filter_rsrp_data', {
          method: 'POST',
          body: formData
        })
          .then(response => response.json())
          .then(data => {
            if (data.error) {
              alert('Error: ' + data.error);
              return;
            }

            updateRsrpTable(data.data);
            updateRsrpStatus(data.filtered_count, data.total_count);
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error filtering RSRP data');
          });
      }

      function applyCommonRsrpFilters() {
        const form = document.getElementById('commonRsrpFilterForm');
        const formData = new FormData(form);

        const headerInputs = document.querySelectorAll('input[form="commonRsrpFilterForm"]');
        headerInputs.forEach(input => {
          if (input.value.trim()) {
            formData.set(input.name, input.value);
          }
        });

        fetch('/filter_common_rsrp_data', {
          method: 'POST',
          body: formData
        })
          .then(response => response.json())
          .then(data => {
            if (data.error) {
              alert('Error: ' + data.error);
              return;
            }

            updateCommonRsrpTable(data.data);
            updateCommonRsrpStatus(data.filtered_count, data.total_count);
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error filtering common RSRP data');
          });
      }

      function clearRsrpFilters() {
        const form = document.getElementById('rsrpFilterForm');
        const inputs = form.querySelectorAll('input[type="text"], input[type="number"], select');
        inputs.forEach(input => {
          if (input.name !== 'msisdn') {
            input.value = '';
          }
        });

        const headerInputs = document.querySelectorAll('input[form="rsrpFilterForm"]');
        headerInputs.forEach(input => {
          input.value = '';
        });

        location.reload();
      }

      function clearCommonRsrpFilters() {
        const form = document.getElementById('commonRsrpFilterForm');
        const inputs = form.querySelectorAll('input[type="text"], input[type="number"], select');
        inputs.forEach(input => {
          if (input.name !== 'msisdn') {
            input.value = '';
          }
        });

        const headerInputs = document.querySelectorAll('input[form="commonRsrpFilterForm"]');
        headerInputs.forEach(input => {
          input.value = '';
        });

        location.reload();
      }

      function updateRsrpTable(data) {
        const tbody = document.getElementById('rsrpTableBody');
        tbody.innerHTML = '';

        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted"><i class="fas fa-info-circle"></i> No RSRP data matches the current filters</td></tr>';
          updateRsrpStats(0, 0);
          return;
        }

        const groupedData = {};
        data.forEach(row => {
          const siteName = row['Site_Name'];
          const siteId = row['Site_ID'];

          if (!groupedData[siteName]) {
            groupedData[siteName] = {};
          }
          if (!groupedData[siteName][siteId]) {
            groupedData[siteName][siteId] = [];
          }
          groupedData[siteName][siteId].push(row);
        });

        Object.keys(groupedData).forEach(siteName => {
          const siteNameGroups = groupedData[siteName];
          const totalSiteNameRows = Object.values(siteNameGroups).reduce((sum, arr) => sum + arr.length, 0);
          let siteNameRowIndex = 0;

          Object.keys(siteNameGroups).forEach(siteId => {
            const siteIdRows = siteNameGroups[siteId];

            siteIdRows.forEach((row, cellIndex) => {
              const tr = document.createElement('tr');
              tr.className = 'rsrp-row';

              let html = '';

              if (siteNameRowIndex === 0) {
                html += `<td rowspan="${totalSiteNameRows}" class="rsrp-site-cell">${siteName}</td>`;
              }

              if (cellIndex === 0) {
                html += `<td rowspan="${siteIdRows.length}" class="rsrp-site-id-cell">${siteId}</td>`;
              }

              const range1 = parseFloat(row['RSRP Range 1 (>-105dBm) %']) || 0;
              const range2 = parseFloat(row['RSRP Range 2 (-105~-110dBm) %']) || 0;
              const range3 = parseFloat(row['RSRP Range 3 (-110~-115dBm) %']) || 0;
              const range4 = parseFloat(row['RSRP < -115dBm %']) || 0;

              html += `
              <td class="rsrp-cell-name">${row['Cell_Name']}</td>
              <td class="rsrp-data-cell ${getRsrpRangeClass(range1, 'excellent')}">${range1.toFixed(1)}%</td>
              <td class="rsrp-data-cell ${getRsrpRangeClass(range2, 'good')}">${range2.toFixed(1)}%</td>
              <td class="rsrp-data-cell ${getRsrpRangeClass(range3, 'fair')}">${range3.toFixed(1)}%</td>
              <td class="rsrp-data-cell ${getRsrpRangeClass(range4, 'poor')}">${range4.toFixed(1)}%</td>
            `;

              tr.innerHTML = html;
              tbody.appendChild(tr);
              siteNameRowIndex++;
            });
          });
        });

        updateRsrpStats(data.length, data.length);
      }

      function updateCommonRsrpTable(data) {
        const tbody = document.getElementById('commonRsrpTableBody');
        tbody.innerHTML = '';

        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted"><i class="fas fa-info-circle"></i> No RSRP data matches the current filters</td></tr>';
          updateCommonRsrpStats(0, 0);
          return;
        }

        const groupedData = {};
        data.forEach(row => {
          const siteName = row['Site_Name'];
          const siteId = row['Site_ID'];

          if (!groupedData[siteName]) {
            groupedData[siteName] = {};
          }
          if (!groupedData[siteName][siteId]) {
            groupedData[siteName][siteId] = [];
          }
          groupedData[siteName][siteId].push(row);
        });

        Object.keys(groupedData).forEach(siteName => {
          const siteNameGroups = groupedData[siteName];
          const totalSiteNameRows = Object.values(siteNameGroups).reduce((sum, arr) => sum + arr.length, 0);
          let siteNameRowIndex = 0;

          Object.keys(siteNameGroups).forEach(siteId => {
            const siteIdRows = siteNameGroups[siteId];

            siteIdRows.forEach((row, cellIndex) => {
              const tr = document.createElement('tr');
              tr.className = 'rsrp-row';

              let html = '';

              if (siteNameRowIndex === 0) {
                html += `<td rowspan="${totalSiteNameRows}" class="rsrp-site-cell">${siteName}</td>`;
              }

              if (cellIndex === 0) {
                html += `<td rowspan="${siteIdRows.length}" class="rsrp-site-id-cell">${siteId}</td>`;
              }

              const range1 = parseFloat(row['RSRP Range 1 (>-105dBm) %']) || 0;
              const range2 = parseFloat(row['RSRP Range 2 (-105~-110dBm) %']) || 0;
              const range3 = parseFloat(row['RSRP Range 3 (-110~-115dBm) %']) || 0;
              const range4 = parseFloat(row['RSRP < -115dBm %']) || 0;

              html += `
              <td class="rsrp-cell-name">${row['Cell_Name']}</td>
              <td class="rsrp-data-cell ${getRsrpRangeClass(range1, 'excellent')}">${range1.toFixed(1)}%</td>
              <td class="rsrp-data-cell ${getRsrpRangeClass(range2, 'good')}">${range2.toFixed(1)}%</td>
              <td class="rsrp-data-cell ${getRsrpRangeClass(range3, 'fair')}">${range3.toFixed(1)}%</td>
              <td class="rsrp-data-cell ${getRsrpRangeClass(range4, 'poor')}">${range4.toFixed(1)}%</td>
            `;

              tr.innerHTML = html;
              tbody.appendChild(tr);
              siteNameRowIndex++;
            });
          });
        });

        updateCommonRsrpStats(data.length, data.length);
      }

      function getRsrpRangeClass(value, type) {
        // Apply color coding based on percentage thresholds
        if (type === 'excellent' && value > 70) return 'rsrp-range-excellent';
        if (type === 'good' && value > 60) return 'rsrp-range-good';
        if (type === 'fair' && value > 50) return 'rsrp-range-fair';
        if (type === 'poor' && value > 40) return 'rsrp-range-poor';
        
        // General color coding for any high values
        if (value > 80) return 'rsrp-range-excellent';
        if (value > 60) return 'rsrp-range-good';
        if (value > 40) return 'rsrp-range-fair';
        if (value > 20) return 'rsrp-range-poor';
        
        return '';
      }

      function updateRsrpStats(filteredCount, totalCount) {
        const statsDiv = document.getElementById('rsrpStats');
        if (statsDiv) {
          if (filteredCount < totalCount) {
            statsDiv.innerHTML = `<i class="fas fa-filter"></i> Showing ${filteredCount} of ${totalCount} records`;
          } else {
            statsDiv.innerHTML = `<i class="fas fa-table"></i> ${totalCount} records total`;
          }
        }
      }

      function updateCommonRsrpStats(filteredCount, totalCount) {
        const statsDiv = document.getElementById('commonRsrpStats');
        if (statsDiv) {
          if (filteredCount < totalCount) {
            statsDiv.innerHTML = `<i class="fas fa-filter"></i> Showing ${filteredCount} of ${totalCount} records`;
          } else {
            statsDiv.innerHTML = `<i class="fas fa-table"></i> ${totalCount} records total`;
          }
        }
      }

      function updateRsrpStatus(filteredCount, totalCount) {
        const statusDiv = document.getElementById('rsrpStatus');
        if (statusDiv) {
          if (filteredCount < totalCount) {
            statusDiv.textContent = `Showing ${filteredCount} of ${totalCount} RSRP records (filtered)`;
          } else {
            statusDiv.textContent = `Showing all ${totalCount} RSRP records`;
          }
        }
        updateRsrpStats(filteredCount, totalCount);
      }

      function updateCommonRsrpStatus(filteredCount, totalCount) {
        const statusDiv = document.getElementById('commonRsrpStatus');
        if (statusDiv) {
          if (filteredCount < totalCount) {
            statusDiv.textContent = `Showing ${filteredCount} of ${totalCount} common location RSRP records (filtered)`;
          } else {
            statusDiv.textContent = `Showing all ${totalCount} common location RSRP records`;
          }
        }
        updateCommonRsrpStats(filteredCount, totalCount);
      }
    </script>

    {% elif error %}
    <div class="container mt-4">
      <div class="alert alert-danger"><strong>Error:</strong> {{ error }}</div>
    </div>
    {% endif %}

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
</body>

</html>