<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>MSISDN Information</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    .tab-content {
      margin-top: 20px;
      height: 200px;
    }

    .logout-btn {
      position: absolute;
      top: 20px;
      right: 20px;
    }

    .map-preview {
      height: 300px;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
    }



    /* Simple Table Styling */
    .table th input.form-control-sm {
      font-size: 0.75rem;
      padding: 4px 6px;
      height: 28px;
    }

    /* Unified RSRP Table Styling */
    .rsrp-table {
      table-layout: fixed;
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    .rsrp-table th,
    .rsrp-table td {
      word-wrap: break-word;
      white-space: normal;
      vertical-align: middle;
      padding: 8px 6px;
      border: 1px solid #dee2e6;
    }

    /* Header styling */
    .rsrp-table thead th {
      background-color: #6c757d;
      color: white;
      text-align: center;
      font-weight: 600;
      vertical-align: top;
      padding: 10px 6px;
    }

    .rsrp-table thead th div {
      text-align: center;
    }

    .rsrp-table thead th input.form-control-sm {
      font-size: 0.7rem;
      padding: 2px 4px;
      height: auto;
      width: 100%;
      box-sizing: border-box;
    }

    /* Fixed column widths */
    .rsrp-table th:nth-child(1),
    .rsrp-table td:nth-child(1) {
      width: 140px;
      min-width: 140px;
      max-width: 140px;
    }

    .rsrp-table th:nth-child(2),
    .rsrp-table td:nth-child(2) {
      width: 100px;
      min-width: 100px;
      max-width: 100px;
    }

    .rsrp-table th:nth-child(3),
    .rsrp-table td:nth-child(3) {
      width: 160px;
      min-width: 160px;
      max-width: 160px;
    }

    .rsrp-table td:nth-child(6),
    .rsrp-table td:nth-child(7) {
      width: 110px;
      min-width: 110px;
      max-width: 110px;
    }

    .rsrp-table th:nth-child(8),
    .rsrp-table th:nth-child(9),
    .rsrp-table th:nth-child(10),
    .rsrp-table th:nth-child(11),
    .rsrp-table th:nth-child(12),
    .rsrp-table td:nth-child(8),
    .rsrp-table td:nth-child(9),
    .rsrp-table td:nth-child(10),
    .rsrp-table td:nth-child(11),
    .rsrp-table td:nth-child(12) {
      width: 120px;
      min-width: 120px;
      max-width: 120px;
    }

    /* Site Name column styling */
    .rsrp-site-cell {
      background-color: #f8f9fa;
      font-weight: bold;
      border-right: 2px solid #dee2e6;
    }

    /* Site ID column styling */
    .rsrp-site-id-cell {
      background-color: #e9ecef;
      font-weight: 600;
      border-right: 1px solid #dee2e6;
    }

    /* Cell Name column styling */
    .rsrp-cell-name {
      background-color: #ffffff;
    }

    /* Data columns styling */
    .rsrp-data-cell {
      background-color: #ffffff;
      text-align: center;
    }

    /* Merged average columns styling */
    .rsrp-table td:nth-child(10),
    .rsrp-table td:nth-child(11) {
      background-color: #e3f2fd;
      font-weight: 600;
      border-left: 2px solid #2196f3;
      vertical-align: middle;
    }

    /* Signal Quality column styling */
    .rsrp-quality-cell {
      background-color: #f8f9fa;
      text-align: center;
      vertical-align: middle;
      border-left: 2px solid #6c757d;
    }

    .rsrp-quality-cell .badge {
      font-size: 0.9rem;
      padding: 6px 12px;
    }

    .rsrp-table tbody tr:hover td:nth-child(10),
    .rsrp-table tbody tr:hover td:nth-child(11) {
      background-color: #bbdefb;
    }

    .rsrp-table tbody tr:hover .rsrp-quality-cell {
      background-color: #e9ecef;
    }

    /* Hover effects */
    .rsrp-table tbody tr:hover {
      background-color: #f8f9fa;
      transition: background-color 0.15s ease-in-out;
    }

    .rsrp-table tbody tr:hover .rsrp-site-cell {
      background-color: #e9ecef;
    }

    .rsrp-table tbody tr:hover .rsrp-site-id-cell {
      background-color: #dee2e6;
    }

    /* RSRP section styling */
    .rsrp-section {
      margin-bottom: 2rem;
    }

    .rsrp-section h5 {
      color: #495057;
      font-weight: 600;
      border-bottom: 2px solid #dee2e6;
      padding-bottom: 0.5rem;
      margin-bottom: 1.5rem;
    }

    /* Filter controls styling */
    .rsrp-filter-controls {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }

    .rsrp-filter-controls .form-control-sm,
    .rsrp-filter-controls .form-select-sm {
      font-size: 0.8rem;
      height: 32px;
    }

    /* Status text */
    .rsrp-status {
      margin-top: 0.75rem;
      font-size: 0.85rem;
      color: #6c757d;
    }

    /* Table responsive wrapper */
    .table-responsive {
      overflow-x: auto;
      margin-bottom: 1rem;
    }

    /* RSRP Range Color Coding Classes */
    /* .rsrp-range-excellent {
      background-color: #d4edda !important;
      color: #155724 !important;
      font-weight: 600 !important;
    }

    .rsrp-range-good {
      background-color: #d1ecf1 !important;
      color: #0c5460 !important;
      font-weight: 600 !important;
    }

    .rsrp-range-fair {
      background-color: #fff3cd !important;
      color: #856404 !important;
      font-weight: 600 !important;
    }

    .rsrp-range-poor {
      background-color: #f8d7da !important;
      color: #721c24 !important;
      font-weight: 600 !important;
    } */

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .rsrp-table {
        font-size: 0.75rem;
      }

      .rsrp-table th:nth-child(1),
      .rsrp-table td:nth-child(1) {
        width: 120px;
        min-width: 120px;
        max-width: 120px;
      }

      .rsrp-table th:nth-child(2),
      .rsrp-table td:nth-child(2) {
        width: 80px;
        min-width: 80px;
        max-width: 80px;
      }

      .rsrp-table th:nth-child(3),
      .rsrp-table td:nth-child(3) {
        width: 130px;
        min-width: 130px;
        max-width: 130px;
      }

      .rsrp-table th:nth-child(4),
      .rsrp-table th:nth-child(5),
      .rsrp-table th:nth-child(6),
      .rsrp-table th:nth-child(7),
      .rsrp-table td:nth-child(4),
      .rsrp-table td:nth-child(5),
      .rsrp-table td:nth-child(6),
      .rsrp-table td:nth-child(7) {
        width: 90px;
        min-width: 90px;
        max-width: 90px;
      }

      .rsrp-table th:nth-child(8),
      .rsrp-table th:nth-child(9),
      .rsrp-table th:nth-child(10),
      .rsrp-table th:nth-child(11),
      .rsrp-table th:nth-child(12),
      .rsrp-table td:nth-child(8),
      .rsrp-table td:nth-child(9),
      .rsrp-table td:nth-child(10),
      .rsrp-table td:nth-child(11),
      .rsrp-table td:nth-child(12) {
        width: 95px;
        min-width: 95px;
        max-width: 95px;
      }
    }

    /* Range Filter Styling */
    .range-filter-group {
      border: 1px solid #e9ecef;
      border-radius: 6px;
      padding: 8px;
      background-color: #f8f9fa;
    }

    .range-filter-group label {
      font-weight: 600;
      color: #495057;
    }

    .legacy-filters {
      border-top: 1px solid #dee2e6;
      padding-top: 12px;
      margin-top: 8px;
    }

    .card-header h6 {
      margin-bottom: 2px;
    }
  </style>
</head>

<body>
  <div class="container mt-5">
    <a href="{{ url_for('logout') }}" class="btn btn-outline-danger logout-btn">
      Logout
    </a>
    <div class="col-md-6 offset-md-3">
      <div class="card p-4 shadow-sm">
        <h2 class="mb-4">Enter MSISDN to Retrieve Information</h2>
        <form id="search-form" action="/search" method="POST">
          <div class="mb-3">
            <label for="msisdn" class="form-label">MSISDN</label>
            <input type="text" class="form-control" id="msisdn" name="msisdn" required />
          </div>
          <button type="submit" class="btn btn-primary w-100" id="search-btn">Search</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Overlay Popup for AI Overview -->
  <div id="ai-overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.45); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:12px; max-width:600px; width:90vw; margin:auto; padding:32px 24px; box-shadow:0 8px 32px rgba(0,0,0,0.18); position:relative;">
      <h4 class="mb-3 text-primary">Overview</h4>
      <div id="ai-summary-popup-content">
        {% if ai_summary %}
          <pre style="white-space: pre-wrap; word-break: break-word; background: #f8f9fa; border-radius: 6px; padding: 16px; font-size: 1rem; max-height:300px; overflow-y:auto;">{{ ai_summary }}</pre>
        {% else %}
          <div class="text-center">
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            <span>Generating overview...</span>
          </div>
        {% endif %}
      </div>
      <div class="mt-4 text-center">
        <button class="btn btn-outline-secondary" onclick="closeAIPopup()">Close</button>
      </div>
    </div>
  </div>

  <!-- Overlayed AI Summary Popup -->
  <div id="aiSummaryPopup" class="modal" tabindex="-1" role="dialog" style="display: none; position: fixed; z-index: 9999; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.45);">
    <div class="modal-dialog modal-lg" role="document" style="margin-top: 5vh;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Overview</h5>
                <button type="button" class="close" onclick="closeAISummaryPopup()" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <pre id="aiSummaryContent" style="white-space: pre-wrap; font-size: 1rem; background: #f8f9fa; border-radius: 6px; padding: 1rem;">{{ ai_summary }}</pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAISummaryPopup()">Close</button>
            </div>
        </div>
    </div>
</div>

  {% if result %}
  <div class="container-fluid px-4 mt-4">
    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs" id="infoTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button"
          role="tab" aria-controls="details" aria-selected="true">
          Details
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="location-tab" data-bs-toggle="tab" data-bs-target="#location" type="button"
          role="tab" aria-controls="location" aria-selected="false">
          Location Map
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="graphs-tab" data-bs-toggle="tab" data-bs-target="#graphs" type="button" role="tab"
          aria-controls="graphs" aria-selected="false">
          Usage Graphs
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="rsrp-tab" data-bs-toggle="tab" data-bs-target="#rsrp" type="button" role="tab"
          aria-controls="rsrp" aria-selected="false">
          RSRP Data
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="lte-util-tab" data-bs-toggle="tab" data-bs-target="#lte-util" type="button" role="tab"
          aria-controls="lte-util" aria-selected="false">
          LTE Utilization
        </button>
      </li>
      <!-- <li class="nav-item" role="presentation">
        <button class="nav-link" id="nearest-locations-tab" data-bs-toggle="tab" data-bs-target="#nearest-locations" type="button" role="tab"
          aria-controls="nearest-locations" aria-selected="false">
          Nearest Locations
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="network-performance-tab" data-bs-toggle="tab" data-bs-target="#network-performance" type="button" role="tab"
          aria-controls="network-performance" aria-selected="false">
          Network Performance
        </button>
      </li> -->

    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="infoTabsContent">
      <div class="tab-pane fade show active" id="details" role="tabpanel" aria-labelledby="details-tab">
        <div class="card p-4 mt-3">
          1. Subscriber Identification
          <table class="table table-bordered">
            <tr>
              <td><strong>MSISDN:</strong></td>
              <td>{{ result['MSISDN'] }}</td>
            </tr>
            <tr>
              <td><strong>IMSI:</strong></td>
              <td>{{ result['IMSI'] }}</td>
            </tr>
            <tr>
              <td><strong>IMEI:</strong></td>
              <td>{{ result['IMEI']}}</td>
            </tr>
          </table>

          <br>
          2. Device Information
          <table class="table table-bordered">
            <tr>
              <td><strong>Device Manufacturer:</strong></td>
              <td>{{ result['Brand']}}</td>
            </tr>
            <tr>
              <td><strong>Model</strong></td>
              <td>{{ result['Model'] }}</td>
            </tr>
            <tr>
              <td><strong>Device Type</strong></td>
              <td>{{ result['Device Type'] }}</td>
            </tr>
            <tr>
              <td><strong>Primary Hardware Type</strong></td>
              <td>{{ result['Primary Hardware Type'] }}</td>
            </tr>
            <tr>
              <td><strong>Year Released</strong></td>
              <td>{{ result['Year Released'] }}</td>
            </tr>
            <tr>
              <td><strong>Operating System Version</strong></td>
              <td>{{ result['OS'] }}</td>
            </tr>
            <tr>
              <td><strong>VoLTE Support</strong></td>
              <td>{{ result['VoLTE'] }}</td>
            </tr>
            <tr>
              <td><strong>SIM Type</strong></td>
              <td>{{ result['SIM Type'] }}</td>
            </tr>
            <tr>
              <td><strong>VoLTE-provisioning Status</strong></td> <!---->
            </tr>
          </table>
          <br>

          3. Location Data
          <table class="table table-bordered">
            <tr>
              <td>Recent Cell Location</td>
            </tr>
            <tr>
              <td><strong>Cell Code:</strong></td>
              <td>{{ result['Cellcode'] }}</td>
            </tr>
            <tr>
              <td><strong>Site Name:</strong></td>
              <td>{{ result['Sitename'] }}</td>
            </tr>
            <tr>
              <td><strong>Coordinates:</strong></td>
              <td>Lat: {{ result['Lat'] }}, Lon: {{ result['Lon'] }}</td>
            </tr>
            <tr>
              <td><strong>Region:</strong></td>
              <td>{{ result['Region'] }}</td>
            </tr>
            <tr>
              <td><strong>District:</strong></td>
              <td>{{ result['District'] }}</td>
            </tr>
            <tr>
              <td><strong>LAC:</strong></td>
              <td>{{ result['LAC'] }}</td>
            </tr>
            <tr>
              <td><strong>Cell_ID:</strong></td>
              <td>{{ result['SAC'] }}</td>
            </tr>
            {% if result["Common Cell Locations"] %}
            {% for loc in result["Common Cell Locations"] %}
            <tr>
              <td>Common Cell Location</td>
            </tr>
            <tr>
              <td><strong>Cell Code</strong></td>
              <td>{{ loc.CELL_CODE }}</td>
            </tr>
            <tr>
              <td><strong>Site Name</strong></td>
              <td>{{ loc.SITE_NAME }}</td>
            </tr>
            <tr>
              <td><strong>Coordinates:</strong></td>
              <td>
                {% if loc.LAT and loc.LON and loc.LAT != 'Not Found' and loc.LON != 'Not Found' %}
                Lat: {{ loc.LAT }}, Lon: {{ loc.LON }}
                {% else %}
                Not Available
                {% endif %}
              </td>
            </tr>
            <tr>
              <td><strong>District</strong></td>
              <td>{{ loc.DISTRICT }}</td>
            </tr>
            <tr>
              <td><strong>LAC</strong></td>
              <td>{{ loc.LAC }}</td>
            </tr>
            <tr>
              <td><strong>Cell_ID</strong></td>
              <td>{{ loc.CELL }}</td>
            </tr>
            {% if not loop.last %}
            <tr>
              <td colspan="2" style="border-top: 2px solid #dee2e6;"></td>
            </tr>
            {% endif %}
            {% endfor %}
            {% else %}
            <tr>
              <td><strong>Common Locations:</strong></td>
              <td class="text-muted">No common locations found for this MSISDN.</td>
            </tr>
            {% endif %}
          </table>

          <br>
        </div>
      </div>


      <!-- Location Map Tab Content-->
      <div class="tab-pane fade" id="location" role="tabpanel" aria-labelledby="location-tab">
        <div class="card p-4 mt-3">
          <div class="map-preview mb-3">
            {% if has_map %}
            <iframe src="{{ url_for('static', filename='temp_map.html') }}" width="100%" height="100%"
              frameborder="0"></iframe>
            {% else %}
            <div class="d-flex align-items-center justify-content-center h-100 bg-light">
              <div class="text-center">
                <p class="mb-2">Other regions map preview not available</p>
                <small class="text-muted">Click "View Other Regions Map" to explore</small>
              </div>
            </div>
            {% endif %}
          </div>

          <div class="d-flex gap-2 flex-wrap">
            <a href="{{ url_for('show_map', msisdn=result.MSISDN) }}" class="btn btn-success" target="_blank">
              View Full Map
            </a>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="graphs" role="tabpanel" aria-labelledby="graphs-tab">
        <div class="row mt-3">
          <!-- Line Chart -->
          <div class="col-md-6 mb-4">
            <div class="card border p-3">
              <div id="monthlyVolumeChart" style="width: 100%; height: 400px"></div>
            </div>
          </div>

          <!-- Bar Chart -->
          <div class="col-md-6 mb-4">
            <div class="card border p-3">
              <div id="totalVolumeChart" style="width: 100%; height: 400px"></div>
            </div>
          </div>
          <!-- Voice Usage Chart -->
          <div class="col-md-6 mb-4">
            <div class="card border p-3">
              <div id="voiceUsageChart" style="width: 100%; height: 400px"></div>
            </div>
          </div>
          <!--SMS Usage Chart-->
          <div class="col-md-6 mb-4">
            <div class="card border p-3">
              <div id="smsUsageChart" style="width: 100%; height: 400px"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- RSRP Data Tab Content -->
      <div class="tab-pane fade" id="rsrp" role="tabpanel" aria-labelledby="rsrp-tab">
        <div class="card p-4 mt-3">
          <div class="rsrp-section">
            <h5 class="mb-3">RSRP for Recent Location</h5>
            <div class="row mb-3">
              <div class="col-md-12">
                <div class="rsrp-filter-controls">
                  <form id="rsrpFilterForm">
                    <input type="hidden" name="msisdn" value="{{ result['MSISDN'] }}">
                    <div class="row g-2 mb-2">
                      <div class="col-md-2">
                        <input type="text" name="cell_name_filter" placeholder="Filter by Cell Name..."
                          class="form-control form-control-sm" oninput="debounceRsrpFilter()"
                          onkeyup="debounceRsrpFilter()">
                      </div>
                      <div class="col-md-2">
                        <select name="sort_by" class="form-select form-select-sm" onchange="debounceRsrpFilter()">
                          <option value="">Sort by...</option>
                          <!-- <option value="Site_Name">Site Name</option> -->
                          <option value="Cell_Name">Cell Name</option>
                          <option value="RSRP Range 1 (>-105dBm) %">RSRP Range 1</option>
                          <option value="RSRP Range 2 (-105~-110dBm) %">RSRP Range 2</option>
                          <option value="RSRP Range 3 (-110~-115dBm) %">RSRP Range 3</option>
                          <option value="RSRP < -115dBm %">RSRP < -115dBm</option>
                        </select>
                      </div>
                      <div class="col-md-2">
                        <select name="sort_order" class="form-select form-select-sm" onchange="debounceRsrpFilter()">
                          <option value="asc">Ascending</option>
                          <option value="desc">Descending</option>
                        </select>
                      </div>
                      <div class="col-md-2">
                        <button type="button" onclick="clearRsrpFilters()" class="btn btn-secondary btn-sm">Clear
                          Filters</button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <!-- RSRP Table -->
            <div class="table-responsive">
              <table class="table table-bordered rsrp-table" id="rsrpTable">
                <thead>
                  <tr>
                    <th>Site Name</th>
                    <th>Site ID</th>
                    <th>Cell Name</th>
                    <th>
                      <div class="text-center">RSRP Range 1 (>-105dBm) %</div>
                      <div class="mt-2">
                        <div class="row g-1">
                          <div class="col-6">
                            <input type="number" name="rsrp_range1_min" placeholder="Min %" step="0.01"
                              class="form-control form-control-sm" form="rsrpFilterForm" oninput="debounceRsrpFilter()">
                          </div>
                          <div class="col-6">
                            <input type="number" name="rsrp_range1_max" placeholder="Max %" step="0.01"
                              class="form-control form-control-sm" form="rsrpFilterForm" oninput="debounceRsrpFilter()">
                          </div>
                        </div>
                      </div>
                    </th>
                    <th>
                      <div class="text-center">RSRP Range 2 (-105~-110dBm) %</div>
                      <div class="mt-2">
                        <div class="row g-1">
                          <div class="col-6">
                            <input type="number" name="rsrp_range2_min" placeholder="Min %" step="0.01"
                              class="form-control form-control-sm" form="rsrpFilterForm" oninput="debounceRsrpFilter()">
                          </div>
                          <div class="col-6">
                            <input type="number" name="rsrp_range2_max" placeholder="Max %" step="0.01"
                              class="form-control form-control-sm" form="rsrpFilterForm" oninput="debounceRsrpFilter()">
                          </div>
                        </div>
                      </div>
                    </th>
                    <th>
                      <div class="text-center">RSRP Range 3 (-110~-115dBm) %</div>
                      <div class="mt-2">
                        <div class="row g-1">
                          <div class="col-6">
                            <input type="number" name="rsrp_range3_min" placeholder="Min %" step="0.01"
                              class="form-control form-control-sm" form="rsrpFilterForm" oninput="debounceRsrpFilter()">
                          </div>
                          <div class="col-6">
                            <input type="number" name="rsrp_range3_max" placeholder="Max %" step="0.01"
                              class="form-control form-control-sm" form="rsrpFilterForm" oninput="debounceRsrpFilter()">
                          </div>
                        </div>
                      </div>
                    </th>
                    <th>
                      <div class="text-center">RSRP < -115dBm %</div>
                          <div class="mt-2">
                            <div class="row g-1">
                              <div class="col-6">
                                <input type="number" name="rsrp_range4_min" placeholder="Min %" step="0.01"
                                  class="form-control form-control-sm" form="rsrpFilterForm"
                                  oninput="debounceRsrpFilter()">
                              </div>
                              <div class="col-6">
                                <input type="number" name="rsrp_range4_max" placeholder="Max %" step="0.01"
                                  class="form-control form-control-sm" form="rsrpFilterForm"
                                  oninput="debounceRsrpFilter()">
                              </div>
                            </div>
                          </div>
                    </th>
                    <th>
                      <div class="text-center">Good Signal Avg (Range 1+2) %</div>
                    </th>
                    <th>
                      <div class="text-center">Poor Signal Avg (Range 3+4) %</div>
                    </th>
                    <th>
                      <div class="text-center">Signal Quality</div>
                    </th>
                  </tr>
                </thead>
                <tbody id="rsrpTableBody">
                  {% if result and result['RSRP Data'] %}
                  {% set grouped_rsrp = {} %}
                  {% for row in result['RSRP Data'] %}
                  {% set site_name = row['Site_Name'] %}
                  {% set site_id = row['Site_ID'] %}
                  {% if site_name not in grouped_rsrp %}
                  {% set _ = grouped_rsrp.update({site_name: {}}) %}
                  {% endif %}
                  {% if site_id not in grouped_rsrp[site_name] %}
                  {% set _ = grouped_rsrp[site_name].update({site_id: []}) %}
                  {% endif %}
                  {% set _ = grouped_rsrp[site_name][site_id].append(row) %}
                  {% endfor %}

                  {% for site_name, site_id_groups in grouped_rsrp.items() %}
                  {% set total_site_name_rows = site_id_groups.values() | map('length') | sum %}
                  {% set site_name_row_index = [0] %}
                  {% set good_signal_avg = None %}
                  {% set poor_signal_avg = None %}
                  {% set signal_quality = None %}
                  {% for site_id, site_id_rows in site_id_groups.items() %}
                  {% for row in site_id_rows %}
                  {% if good_signal_avg is none %}
                  {% set good_signal_avg = row.get('Good Signal Avg (Range 1+2) %', 0) %}
                  {% endif %}
                  {% if poor_signal_avg is none %}
                  {% set poor_signal_avg = row.get('Poor Signal Avg (Range 3+4) %', 0) %}
                  {% endif %}
                  {% if signal_quality is none %}
                  {% set signal_quality = row.get('Signal Quality', 'Poor') %}
                  {% endif %}
                  <tr>
                    {% if site_name_row_index[0] == 0 %}
                    <td rowspan="{{ total_site_name_rows }}" class="rsrp-site-cell">{{ site_name }}</td>
                    {% endif %}
                    {% if loop.index == 1 %}
                    <td rowspan="{{ site_id_rows|length }}" class="rsrp-site-id-cell">{{ site_id }}</td>
                    {% endif %}
                    <td class="rsrp-cell-name">{{ row['Cell_Name'] }}</td>
                    <td class="rsrp-data-cell">{{ row['RSRP Range 1 (>-105dBm) %'] }}%</td>
                    <td class="rsrp-data-cell">{{ row['RSRP Range 2 (-105~-110dBm) %'] }}%</td>
                    <td class="rsrp-data-cell">{{ row['RSRP Range 3 (-110~-115dBm) %'] }}%</td>
                    <td class="rsrp-data-cell">{{ row['RSRP < -115dBm %'] }}%</td>
                        {% if site_name_row_index[0] == 0 %}
                    <td rowspan="{{ total_site_name_rows }}" class="rsrp-data-cell">{{ good_signal_avg }}%</td>
                    <td rowspan="{{ total_site_name_rows }}" class="rsrp-data-cell">{{ poor_signal_avg }}%</td>
                    {% endif %}
                    {% if site_name_row_index[0] == 0 %}
                    <td rowspan="{{ total_site_name_rows }}" class="rsrp-quality-cell">
                      <span
                        class="badge {% if signal_quality == 'Good' %}bg-success{% else %}bg-danger{% endif %}">
                        {{ signal_quality }}
                      </span>
                    </td>
                    {% endif %}
                  </tr>
                  {% set _ = site_name_row_index.append(site_name_row_index.pop() + 1) %}
                  {% endfor %}
                  {% endfor %}
                  {% endfor %}
                  {% else %}
                  <tr>
                    <td colspan="12" class="text-center text-muted">No RSRP data available for this MSISDN</td>
                  </tr>
                  {% endif %}
                </tbody>
              </table>
              <div id="rsrpStatus" class="rsrp-status"></div>
            </div>
          </div>

          <!-- Common Locations RSRP Data -->
          {% if result["Common Cell Locations"] %}
          {% set all_common_rsrp_data = [] %}
          {% for loc in result["Common Cell Locations"] %}
          {% set loc_rsrp_data = loc.get('RSRP_DATA', []) %}
          {% for row in loc_rsrp_data %}
          {% set enhanced_row = row.copy() %}
          {% set _ = all_common_rsrp_data.append(enhanced_row) %}
          {% endfor %}
          {% endfor %}

          {% if all_common_rsrp_data %}
          <hr class="my-4">
          <div class="rsrp-section">
            <h5 class="mb-3">RSRP for Common Locations ({{ result["Common Cell Locations"]|length }} locations)</h5>

            <!-- RSRP Filtering Controls for all common locations -->
            <div class="row mb-3">
              <div class="col-md-12">
                <div class="rsrp-filter-controls">
                  <form id="commonRsrpFilterForm">
                    <input type="hidden" name="msisdn" value="{{ result['MSISDN'] }}">
                    <div class="row g-2 mb-2">
                      <div class="col-md-2">
                        <input type="text" name="cell_name_filter" placeholder="Filter by Cell Name..."
                          class="form-control form-control-sm" oninput="debounceCommonRsrpFilter()"
                          onkeyup="debounceCommonRsrpFilter()">
                      </div>
                      <div class="col-md-2">
                        <input type="text" name="site_name_filter" placeholder="Filter by Site Name..."
                          class="form-control form-control-sm" oninput="debounceCommonRsrpFilter()"
                          onkeyup="debounceCommonRsrpFilter()">
                      </div>
                      <div class="col-md-2">
                        <select name="sort_by" class="form-select form-select-sm" onchange="debounceCommonRsrpFilter()">
                          <option value="">Sort by...</option>
                          <option value="Site_Name">Site Name</option>
                          <option value="Cell_Name">Cell Name</option>
                          <option value="RSRP Range 1 (>-105dBm) %">RSRP Range 1</option>
                          <option value="RSRP Range 2 (-105~-110dBm) %">RSRP Range 2</option>
                          <option value="RSRP Range 3 (-110~-115dBm) %">RSRP Range 3</option>
                          <option value="RSRP < -115dBm %">RSRP < -115dBm</option>
                        </select>
                      </div>
                      <div class="col-md-2">
                        <select name="sort_order" class="form-select form-select-sm"
                          onchange="debounceCommonRsrpFilter()">
                          <option value="asc">Ascending</option>
                          <option value="desc">Descending</option>
                        </select>
                      </div>
                      <div class="col-md-2">
                        <button type="button" onclick="clearCommonRsrpFilters()" class="btn btn-secondary btn-sm">Clear
                          Filters</button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <!-- Unified RSRP Table for all common locations -->
            <div class="table-responsive">
              <table class="table table-bordered rsrp-table" id="commonRsrpTable">
                <thead>
                  <tr>
                    <th>Site Name</th>
                    <th>Site ID</th>
                    <th>Cell Name</th>
                    <th>
                      <div class="text-center">RSRP Range 1 (>-105dBm) %</div>
                      <div class="mt-2">
                        <div class="row g-1">
                          <div class="col-6">
                            <input type="number" name="rsrp_range1_min" placeholder="Min %" step="0.01"
                              class="form-control form-control-sm" form="commonRsrpFilterForm"
                              oninput="debounceCommonRsrpFilter()">
                          </div>
                          <div class="col-6">
                            <input type="number" name="rsrp_range1_max" placeholder="Max %" step="0.01"
                              class="form-control form-control-sm" form="commonRsrpFilterForm"
                              oninput="debounceCommonRsrpFilter()">
                          </div>
                        </div>
                      </div>
                    </th>
                    <th>
                      <div class="text-center">RSRP Range 2 (-105~-110dBm) %</div>
                      <div class="mt-2">
                        <div class="row g-1">
                          <div class="col-6">
                            <input type="number" name="rsrp_range2_min" placeholder="Min %" step="0.01"
                              class="form-control form-control-sm" form="commonRsrpFilterForm"
                              oninput="debounceCommonRsrpFilter()">
                          </div>
                          <div class="col-6">
                            <input type="number" name="rsrp_range2_max" placeholder="Max %" step="0.01"
                              class="form-control form-control-sm" form="commonRsrpFilterForm"
                              oninput="debounceCommonRsrpFilter()">
                          </div>
                        </div>
                      </div>
                    </th>
                    <th>
                      <div class="text-center">RSRP Range 3 (-110~-115dBm) %</div>
                      <div class="mt-2">
                        <div class="row g-1">
                          <div class="col-6">
                            <input type="number" name="rsrp_range3_min" placeholder="Min %" step="0.01"
                              class="form-control form-control-sm" form="commonRsrpFilterForm"
                              oninput="debounceCommonRsrpFilter()">
                          </div>
                          <div class="col-6">
                            <input type="number" name="rsrp_range3_max" placeholder="Max %" step="0.01"
                              class="form-control form-control-sm" form="commonRsrpFilterForm"
                              oninput="debounceCommonRsrpFilter()">
                          </div>
                        </div>
                      </div>
                    </th>
                    <th>
                      <div class="text-center">RSRP < -115dBm %</div>
                          <div class="mt-2">
                            <div class="row g-1">
                              <div class="col-6">
                                <input type="number" name="rsrp_range4_min" placeholder="Min %" step="0.01"
                                  class="form-control form-control-sm" form="commonRsrpFilterForm"
                                  oninput="debounceCommonRsrpFilter()">
                              </div>
                              <div class="col-6">
                                <input type="number" name="rsrp_range4_max" placeholder="Max %" step="0.01"
                                  class="form-control form-control-sm" form="commonRsrpFilterForm"
                                  oninput="debounceCommonRsrpFilter()">
                              </div>
                            </div>
                          </div>
                    </th>
                    <th>
                      <div class="text-center">Good Signal Avg (Range 1+2) %</div>
                    </th>
                    <th>
                      <div class="text-center">Poor Signal Avg (Range 3+4) %</div>
                    </th>
                    <th>
                      <div class="text-center">Signal Quality</div>
                    </th>
                  </tr>
                </thead>
                <tbody id="commonRsrpTableBody">
                  {% set grouped_rsrp = {} %}
                  {% for row in all_common_rsrp_data %}
                  {% set site_name = row['Site_Name'] %}
                  {% set site_id = row['Site_ID'] %}
                  {% if site_name not in grouped_rsrp %}
                  {% set _ = grouped_rsrp.update({site_name: {}}) %}
                  {% endif %}
                  {% if site_id not in grouped_rsrp[site_name] %}
                  {% set _ = grouped_rsrp[site_name].update({site_id: []}) %}
                  {% endif %}
                  {% set _ = grouped_rsrp[site_name][site_id].append(row) %}
                  {% endfor %}

                  {% for site_name, site_id_groups in grouped_rsrp.items() %}
                  {% set site_total_rows = [] %}
                  {% for site_id, site_id_rows in site_id_groups.items() %}
                  {% for row in site_id_rows %}
                  {% set _ = site_total_rows.append(1) %}
                  {% endfor %}
                  {% endfor %}
                  {% set site_row_count = site_total_rows|length %}
                  {% set site_name_row_index = [0] %}
                  {% set first_row = None %}
                  {% for site_id, site_id_rows in site_id_groups.items() %}
                  {% for row in site_id_rows %}
                  {% if first_row is none %}
                  {% set first_row = row %}
                  {% endif %}
                  <tr>
                    {% if site_name_row_index[0] == 0 %}
                    <td rowspan="{{ site_row_count }}" class="rsrp-site-cell">{{ site_name }}</td>
                    {% endif %}
                    {% if loop.index == 1 %}
                    <td rowspan="{{ site_id_rows|length }}" class="rsrp-site-id-cell">{{ site_id }}</td>
                    {% endif %}
                    <td class="rsrp-cell-name">{{ row['Cell_Name'] }}</td>
                    <td class="rsrp-data-cell">{{ row['RSRP Range 1 (>-105dBm) %'] }}%</td>
                    <td class="rsrp-data-cell">{{ row['RSRP Range 2 (-105~-110dBm) %'] }}%</td>
                    <td class="rsrp-data-cell">{{ row['RSRP Range 3 (-110~-115dBm) %'] }}%</td>
                    <td class="rsrp-data-cell">{{ row['RSRP < -115dBm %'] }}%</td>
                        {% if site_name_row_index[0] == 0 %}
                    <td rowspan="{{ site_row_count }}" class="rsrp-data-cell">{{ first_row.get('Good Signal Avg (Range 1+2) %', 0) }}%</td>
                    <td rowspan="{{ site_row_count }}" class="rsrp-data-cell">{{ first_row.get('Poor Signal Avg (Range 3+4) %', 0) }}%</td>
                    {% endif %}
                    {% if site_name_row_index[0] == 0 %}
                    <td rowspan="{{ site_row_count }}" class="rsrp-quality-cell">
                      <span
                        class="badge {% if first_row.get('Signal Quality', 'Poor') == 'Good' %}bg-success{% else %}bg-danger{% endif %}">
                        {{ first_row.get('Signal Quality', 'Poor') }}
                      </span>
                    </td>
                    {% endif %}
                  </tr>
                  {% set _ = site_name_row_index.append(site_name_row_index.pop() + 1) %}
                  {% endfor %}
                  {% endfor %}
                  {% endfor %}
                </tbody>
              </table>
              <div id="commonRsrpStatus" class="rsrp-status"></div>
            </div>
          </div>
          {% endif %}
          {% endif %}
        </div>
      </div>

      <!-- LTE Utilization Tab -->
      <div class="tab-pane fade" id="lte-util" role="tabpanel" aria-labelledby="lte-util-tab">
        <div class="card p-4 mt-3">
          <h5 class="mb-3">LTE Utilization Data</h5>
          
          {% if result['LTE Utilization Data'] and result['LTE Utilization Data']|length > 0 %}
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th>Cell ID</th>
                  <th>Site ID</th>
                  <th>Site Name</th>
                  <th>Sector Utilization (%)</th>
                  <th>Cell Utilization (%)</th>
                  <th>Cell DL Average Throughput BH (Mbps)</th>
                  <th>Cell UL Average Throughput BH (Mbps)</th>
                  <th>Radio Resource Usage BH (DL) %</th>
                </tr>
              </thead>
              <tbody>
                {% for lte_data in result['LTE Utilization Data'] %}
                <tr>
                  <td>{{ lte_data['Cell ID'] or 'N/A' }}</td>
                  <td>{{ lte_data['Site ID'] or 'N/A' }}</td>
                  <td>{{ lte_data['Site Name'] or 'N/A' }}</td>
                  <td>
                    {% set sector_util = lte_data['Sector Utilization (%)'] %}
                    {% if sector_util is not none %}
                      {% if sector_util > 80 %}
                        <span class="badge bg-danger">{{ "%.2f"|format(sector_util) }}%</span>
                      {% elif sector_util > 60 %}
                        <span class="badge bg-warning">{{ "%.2f"|format(sector_util) }}%</span>
                      {% else %}
                        <span class="badge bg-success">{{ "%.2f"|format(sector_util) }}%</span>
                      {% endif %}
                    {% else %}
                      <span class="text-muted">N/A</span>
                    {% endif %}
                  </td>
                  <td>
                    {% set cell_util = lte_data['Cell Utilization (%)'] %}
                    {% if cell_util is not none %}
                      {% if cell_util > 80 %}
                        <span class="badge bg-danger">{{ "%.2f"|format(cell_util) }}%</span>
                      {% elif cell_util > 60 %}
                        <span class="badge bg-warning">{{ "%.2f"|format(cell_util) }}%</span>
                      {% else %}
                        <span class="badge bg-success">{{ "%.2f"|format(cell_util) }}%</span>
                      {% endif %}
                    {% else %}
                      <span class="text-muted">N/A</span>
                    {% endif %}
                  </td>
                  <td>{{ "%.2f"|format(lte_data['Cell DL Average thoughput BH (Mbps)']) if lte_data['Cell DL Average thoughput BH (Mbps)'] is not none else 'N/A' }}</td>
                  <td>{{ "%.2f"|format(lte_data['Cell UL Average thoughput BH (Mbps)']) if lte_data['Cell UL Average thoughput BH (Mbps)'] is not none else 'N/A' }}</td>
                  <td>{{ "%.2f"|format(lte_data['Radio resource usage BH (DL) %']) if lte_data['Radio resource usage BH (DL) %'] is not none else 'N/A' }}%</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          
          <!-- LTE Utilization from Common Cell Locations -->
          {% if result['Common Cell Locations'] %}
          <h6 class="mt-4 mb-3">LTE Utilization from Common Cell Locations</h6>
          {% for common_cell in result['Common Cell Locations'] %}
            {% if common_cell['LTE_UTIL_DATA'] and common_cell['LTE_UTIL_DATA']|length > 0 %}
            <div class="card mb-3">
              <div class="card-header">
                <h6 class="mb-0">{{ common_cell['SITE_NAME'] }} ({{ common_cell['CELL_CODE'] }})</h6>
                <small class="text-muted">District: {{ common_cell['DISTRICT'] }}, Region: {{ common_cell['REGION'] }}</small>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-sm table-striped">
                    <thead>
                      <tr>
                        <th>Cell ID</th>
                        <th>Sector Utilization (%)</th>
                        <th>Cell Utilization (%)</th>
                        <th>Cell DL Average Throughput BH (Mbps)</th>
                        <th>Cell UL Average Throughput BH (Mbps)</th>
                        <th>Radio Resource Usage BH (DL) %</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for lte_data in common_cell['LTE_UTIL_DATA'] %}
                      <tr>
                        <td>{{ lte_data['Cell ID'] or 'N/A' }}</td>
                        <td>
                          {% set sector_util = lte_data['Sector Utilization (%)'] %}
                          {% if sector_util is not none %}
                            {% if sector_util > 80 %}
                              <span class="badge bg-danger bg-opacity-75">{{ "%.1f"|format(sector_util) }}%</span>
                            {% elif sector_util > 60 %}
                              <span class="badge bg-warning bg-opacity-75">{{ "%.1f"|format(sector_util) }}%</span>
                            {% else %}
                              <span class="badge bg-success bg-opacity-75">{{ "%.1f"|format(sector_util) }}%</span>
                            {% endif %}
                          {% else %}
                            N/A
                          {% endif %}
                        </td>
                        <td>
                          {% set cell_util = lte_data['Cell Utilization (%)'] %}
                          {% if cell_util is not none %}
                            {% if cell_util > 80 %}
                              <span class="badge bg-danger bg-opacity-75">{{ "%.1f"|format(cell_util) }}%</span>
                            {% elif cell_util > 60 %}
                              <span class="badge bg-warning bg-opacity-75">{{ "%.1f"|format(cell_util) }}%</span>
                            {% else %}
                              <span class="badge bg-success bg-opacity-75">{{ "%.1f"|format(cell_util) }}%</span>
                            {% endif %}
                          {% else %}
                            N/A
                          {% endif %}
                        </td>
                        <td>{{ "%.1f"|format(lte_data['Cell DL Average thoughput BH (Mbps)']) if lte_data['Cell DL Average thoughput BH (Mbps)'] is not none else 'N/A' }} Mbps</td>
                        <td>{{ "%.1f"|format(lte_data['Cell UL Average thoughput BH (Mbps)']) if lte_data['Cell UL Average thoughput BH (Mbps)'] is not none else 'N/A' }} Mbps</td>
                        <td>{{ "%.1f"|format(lte_data['Radio resource usage BH (DL) %']) if lte_data['Radio resource usage BH (DL) %'] is not none else 'N/A' }}%</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            {% endif %}
          {% endfor %}
          {% endif %}
          
          {% else %}
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            No LTE utilization data available for this MSISDN.
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- External JavaScript Files -->
  <script src="{{ url_for('static', filename='js/app.js') }}"></script>
  <script src="{{ url_for('static', filename='js/charts.js') }}"></script>
  <script src="{{ url_for('static', filename='js/rsrp-filters.js') }}"></script>


  <script>
    // Initialize charts with usage data from server
    document.addEventListener('DOMContentLoaded', function () {
      const usageDataElement = document.getElementById('usage-data');
      if (usageDataElement && typeof initializeUsageCharts === 'function') {
        try {
          const usage = JSON.parse(usageDataElement.textContent);
          initializeUsageCharts(usage);
        } catch (error) {
          console.error('Error initializing charts:', error);
        }
      }
    });
  </script>

  {% elif error %}
  <div class="container mt-4">
    <div class="alert alert-danger"><strong>Error:</strong> {{ error }}</div>
  </div>
  {% endif %}

  <!-- Bootstrap JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
</body>

<script>
// Show overlay popup and fetch AI summary via SSE
function showAIPopup() {
    document.getElementById('ai-overlay').style.display = 'flex';
}

// Polyfill for EventSource with POST (since native EventSource only supports GET)
class EventSourcePolyfill {
    constructor(url, options) {
        this.url = url;
        this.options = options || {};
        this.listeners = {};
        this.closed = false;
        this._start();
    }
    _start() {
        this.xhr = new XMLHttpRequest();
        this.xhr.open('POST', this.url, true);
        if (this.options.headers) {
            for (const k in this.options.headers) {
                this.xhr.setRequestHeader(k, this.options.headers[k]);
            }
        }
        this.xhr.setRequestHeader('Accept', 'text/event-stream');
        this.xhr.onreadystatechange = () => {
            if (this.xhr.readyState === 3 || this.xhr.readyState === 4) {
                const lines = this.xhr.responseText.split(/\r?\n\r?\n/);
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = line.slice(6);
                        if (this.onmessage) this.onmessage({ data });
                    } else if (line.startsWith('event: end')) {
                        if (this.listeners['end']) {
                            for (const fn of this.listeners['end']) fn();
                        }
                    }
                }
            }
        };
        this.xhr.onerror = () => {
            if (this.onerror) this.onerror();
        };
        this.xhr.send(this.options.payload || null);
    }
    addEventListener(event, fn) {
        if (!this.listeners[event]) this.listeners[event] = [];
        this.listeners[event].push(fn);
    }
    close() {
        this.closed = true;
        if (this.xhr) this.xhr.abort();
    }
}

// Details tab navigation from popup
// Removed navigation to details tab from popup
function closeAIPopup() {
    document.getElementById('ai-overlay').style.display = 'none';
    if (window.aiSummaryEventSource) {
        window.aiSummaryEventSource.close();
    }
}

// Intercept search form submit to show popup
document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.getElementById('search-form');
    if (searchForm) {
        searchForm.addEventListener('submit', function(e) {
            // Show popup immediately after form submit
            setTimeout(function() {
                showAIPopup();
            }, 50);
        });
    }
});

    // Show AI Summary Popup after search
    function showAISummaryPopup() {
        document.getElementById('aiSummaryPopup').style.display = 'block';
    }

    function closeAISummaryPopup() {
        document.getElementById('aiSummaryPopup').style.display = 'none';
    }

    // Show popup if AI summary is present and prevent auto-close
    function showPopupIfSummaryPresent() {
        var aiSummary = document.getElementById('aiSummaryContent');
        if (aiSummary && aiSummary.textContent.trim().length > 0) {
            showAISummaryPopup();
        }
    }

    // Show popup instantly after page load (search result)
    document.addEventListener('DOMContentLoaded', function() {
        showPopupIfSummaryPresent();
    });

// Add button to navigate back to AI Overview popup
function showOverviewPopup() {
    // Show the overlayed AI summary popup
    showAISummaryPopup();
}

// Add the button to the tab navigation area (Details tab)
document.addEventListener('DOMContentLoaded', function() {
    var detailsTab = document.getElementById('details-tab');
    if (detailsTab) {
        var overviewBtn = document.createElement('button');
        overviewBtn.className = 'btn btn-outline-primary ms-3';
        overviewBtn.innerText = 'Overview';
        overviewBtn.onclick = showOverviewPopup;
        detailsTab.parentNode.appendChild(overviewBtn);
    }
});
</script>
</body>

</html>