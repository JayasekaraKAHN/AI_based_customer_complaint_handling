<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>3G Call Drop Rate Data Table</title>
    <style>
        body { font-family: Arial, sans-serif; background: #fff; }
        h2 { text-align: center; font-size: 2.2em; font-weight: bold; margin-top: 30px; }
        .table-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            overflow-x: auto;
            overflow-y: auto;
            max-height: 600px;
            border: 1px solid #ccc;
            background: #fff;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            min-width: 600px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 6px 10px;
            text-align: center;
            font-size: 14px;
        }
        th {
            background: #f5f5f5;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        tr:nth-child(even) { background: #fafbfc; }
    </style>
</head>
<body>
    <!-- <h2>3G Call Drop Rate Visualization (2014 - Present)</h2> -->
    <div style="max-width:1600px;margin:0 auto;">
        <div style="display:flex;align-items:center;gap:20px;margin-bottom:20px;">
            <label for="year-filter" style="font-weight:bold;font-size:1.1em;">Filter by Year:</label>
            <select id="year-filter" style="padding:6px 12px;font-size:1.1em;"></select>
            <span id="data-count" style="color:#555;font-size:1em;"></span>
        </div>
        <div id="echart-main" style="height:800px;width:100%;background:#fff;"></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script>
        let allData = null;
        let allDates = null;
        let allYears = null;
        let allY = null;
        let dateCol = '';
        let dropCol = '';
        let chart = null;
        fetch('/call-drop-rate-3g-data')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('echart-main').innerHTML = '<div style="color:red">' + data.error + '</div>';
                    return;
                }
                // Use parsed years from backend if available, else fallback to regex
                const nowYear = new Date().getFullYear();
                allData = data;
                allDates = data.x;
                allY = data.y;
                let tempYears = [];
                if (data.years && Array.isArray(data.years) && data.years.length === data.x.length) {
                    for (let i = 0; i < data.x.length; i++) {
                        let year = data.years[i];
                        if (year && +year >= 2014 && +year <= nowYear) {
                            tempYears.push(String(year));
                        } else {
                            tempYears.push('Unknown');
                        }
                    }
                } else {
                    for (let i = 0; i < data.x.length; i++) {
                        let m = String(data.x[i]).match(/(\d{4})/);
                        let year = m ? parseInt(m[1]) : null;
                        tempYears.push(year ? String(year) : 'Unknown');
                    }
                }
                allYears = tempYears;
                // Only keep data from 2014-present
                let filteredDates = [], filteredY = [], filteredYears = [];
                for (let i = 0; i < allDates.length; i++) {
                    let year = allYears[i];
                    if (year !== 'Unknown' && +year >= 2014 && +year <= nowYear) {
                        filteredDates.push(allDates[i]);
                        filteredY.push(allY[i]);
                        filteredYears.push(year);
                    }
                }
                allDates = filteredDates;
                allY = filteredY;
                allYears = filteredYears;
                const uniqueYears = Array.from(new Set(allYears)).filter(y => y !== 'Unknown').sort();
                dateCol = data.date_col;
                dropCol = data.drop_col;
                // Populate dropdown
                const yearFilter = document.getElementById('year-filter');
                yearFilter.innerHTML = '<option value="all">All Years</option>' + uniqueYears.map(y => `<option value="${y}">${y}</option>`).join('');
                yearFilter.addEventListener('change', function() {
                    renderGraph(this.value);
                });
                renderGraph('all');
            })
            .catch(err => {
                document.getElementById('echart-main').innerHTML = '<div style="color:red">Error loading data.</div>';
            });

        function renderGraph(selectedYear) {
            let x = [], y = [];
            if (selectedYear === 'all') {
                x = allDates;
                y = allY;
            } else {
                for (let i = 0; i < allDates.length; i++) {
                    if (allYears[i] === selectedYear) {
                        x.push(allDates[i]);
                        y.push(allY[i]);
                    }
                }
            }
            document.getElementById('data-count').textContent = `Showing ${x.length} records` + (selectedYear !== 'all' ? ` for ${selectedYear}` : '');
            if (!chart) {
                chart = echarts.init(document.getElementById('echart-main'));
            }
            const option = {
                title: {
                    text: `3G Call Drop Rate (${selectedYear === 'all' ? '2014 - Present' : selectedYear})`,
                    left: 'center',
                    top: 10,
                    textStyle: { fontSize: 28, fontFamily: 'Arial, sans-serif', color: '#222' }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: function(params) {
                        let p = params[0];
                        return `${dateCol}: <b>${p.axisValue}</b><br>${dropCol}: <b>${p.data}</b>`;
                    }
                },
                grid: { left: 80, right: 40, top: 80, bottom: 180 },
                xAxis: {
                    type: 'category',
                    data: x,
                    name: dateCol,
                    nameLocation: 'center',
                    nameGap: 40,
                    axisLabel: { rotate: 45, fontSize: 14, margin: 12 },
                    nameTextStyle: { fontSize: 20 }
                },
                yAxis: {
                    type: 'value',
                    name: dropCol,
                    nameTextStyle: { fontSize: 20 },
                    axisLabel: { fontSize: 16 },
                    min: 0
                },
                series: [{
                    data: y,
                    type: 'line',
                    smooth: false,
                    symbol: 'circle',
                    symbolSize: 10,
                    lineStyle: { color: '#1976d2', width: 3 },
                    itemStyle: { color: '#1976d2' },
                    name: dropCol,
                    showSymbol: true
                }],
                toolbox: {
                    feature: {
                        saveAsImage: { title: 'Save as Image' },
                        dataZoom: { yAxisIndex: 'none' },
                        restore: {}
                    },
                    right: 30
                },
                dataZoom: [
                    { type: 'slider', xAxisIndex: 0, start: 0, end: 100, height: 30, bottom: 120 },
                    { type: 'inside', xAxisIndex: 0 }
                ],
                legend: {
                    data: [dropCol],
                    bottom: 10,
                    textStyle: { fontSize: 16 }
                }
            };
            chart.setOption(option, true);
            window.addEventListener('resize', function() { chart.resize(); });
        }
    </script>
</body>
</html>
