<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HLR VLR Subbase Multi-Line Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <style>
        #main-chart { width: 100vw; height: 80vh; margin: 0 auto; }
        body { font-family: Arial, sans-serif; background: #f8f8f8; }
        .chart-controls { margin: 20px; }
    </style>
</head>
<body>
    <div class="chart-controls">
        <button onclick="downloadImage()">Download Chart as PNG</button>
    </div>
    <div id="main-chart"></div>
    <script>
    async function fetchData() {
        const resp = await fetch('/hlr-vlr-subbase-data');
        return await resp.json();
    }

    function getColorPalette(n) {
        // Generate n visually distinct colors
        const palette = [
            '#5470C6', '#91CC75', '#EE6666', '#FAC858', '#73C0DE', '#3BA272',
            '#FC8452', '#9A60B4', '#EA7CCC', '#6E7074', '#B2B2B2', '#F19797',
            '#FFB980', '#2EC7C9', '#B6A2DE', '#5AB1EF', '#FFB980', '#D87A80',
        ];
        while (palette.length < n) palette.push('#' + Math.floor(Math.random()*16777215).toString(16));
        return palette.slice(0, n);
    }

    function renderChart(data) {
        const chartDom = document.getElementById('main-chart');
        const myChart = echarts.init(chartDom);
        const x = data.x;
        const yCols = data.y_cols;
        const ySeries = data.y_series;
        const colors = getColorPalette(yCols.length);
        const series = yCols.map((col, idx) => ({
            name: col,
            type: 'line',
            data: ySeries[col],
            smooth: false,
            showSymbol: false,
            lineStyle: { width: 2 },
            emphasis: { focus: 'series' },
            color: colors[idx]
        }));
        const option = {
            title: { text: 'HLR VLR Subbase - All Columns', left: 'center' },
            tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
            legend: { data: yCols, type: 'scroll', top: 40 },
            toolbox: { feature: { saveAsImage: {} } },
            grid: { left: 60, right: 40, top: 80, bottom: 80 },
            xAxis: {
                type: 'category',
                data: x,
                name: data.x_col,
                axisLabel: { rotate: 45, fontSize: 12, interval: 0 }
            },
            yAxis: { type: 'value', name: 'Value', axisLabel: { fontSize: 12 } },
            dataZoom: [
                { type: 'slider', xAxisIndex: 0, start: 0, end: 100 },
                { type: 'inside', xAxisIndex: 0, start: 0, end: 100 }
            ],
            series: series
        };
        myChart.setOption(option);
        window.myChart = myChart;
    }

    function downloadImage() {
        if (window.myChart) {
            window.myChart.saveAsImage && window.myChart.saveAsImage();
            // fallback for ECharts 5.x
            const url = window.myChart.getDataURL({ type: 'png' });
            const a = document.createElement('a');
            a.href = url;
            a.download = 'hlr_vlr_subbase_chart.png';
            a.click();
        }
    }

    fetchData().then(data => {
        if (data.error) {
            document.getElementById('main-chart').innerHTML = '<b style="color:red">' + data.error + '</b>';
        } else {
            renderChart(data);
        }
    });
    </script>
</body>
</html>
