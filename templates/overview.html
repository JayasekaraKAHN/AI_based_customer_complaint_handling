<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>MSISDN Overview - {{ result['MSISDN'] }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    .logout-btn {
      position: absolute;
      top: 20px;
      right: 20px;
    }
  </style>
</head>

<body>
  <div class="container-fluid mt-5">
    <a href="{{ url_for('logout') }}" class="btn btn-outline-danger logout-btn">
      Logout
    </a>
    <div class="row">
      <div class="col-12">
        <div class="card p-4 shadow-sm">
        <h2 class="mb-4 text-center">
          <i class="bi bi-robot me-2"></i>Overview
        </h2>
        <h4 class="text-center mb-4 text-primary">{{ result['MSISDN'] }}</h4>
        
        <!-- AI Summary Section -->
        <div class="mb-4">
          <h5 class="mb-3">
            <i class="bi bi-lightbulb me-2 text-warning"></i>
            Summary & Insights
          </h5>
          
          {% if ai_summary %}
          <div class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;">
            <pre class="mb-0" style="white-space: pre-wrap; word-break: break-word;">{{ ai_summary }}</pre>
          </div>
          {% else %}
          <div class="text-center text-muted">
            <i class="bi bi-info-circle me-2"></i>
            Summary could not be generated for this MSISDN. Please try again or contact support.
          </div>
          {% endif %}
        </div>

        <!-- Monthly Usage Summary Section -->
        {% if result and result["Monthly Usage"] %}
        <div class="mb-4">
          <h5 class="mb-3">
            <i class="bi bi-bar-chart-line me-2 text-primary"></i>
            Monthly Usage Summary
          </h5>
          
          <!-- Usage Statistics Cards -->
          <div class="row mb-4">
            <div class="col-md-3 mb-3">
              <div class="card bg-primary text-white">
                <div class="card-body text-center">
                  <i class="bi bi-download fs-2 mb-2"></i>
                  <h6 class="card-title">Total Data Usage</h6>
                  <p class="card-text fs-5">
                    {% if result["Monthly Usage"] and result["Monthly Usage"]["Total"] %}
                      {{ "%.2f GB"|format((result["Monthly Usage"]["Total"]|sum / 1024) if result["Monthly Usage"]["Total"] else 0) }}
                    {% else %}
                      0 GB
                    {% endif %}
                  </p>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card bg-success text-white">
                <div class="card-body text-center">
                  <i class="bi bi-telephone fs-2 mb-2"></i>
                  <h6 class="card-title">Voice Usage</h6>
                  <p class="card-text fs-5">
                    {% if result["Monthly Usage"] and result["Monthly Usage"]["incoming_voice"] and result["Monthly Usage"]["outgoing_voice"] %}
                      {% set total_voice = result["Monthly Usage"]["incoming_voice"]|sum + result["Monthly Usage"]["outgoing_voice"]|sum %}
                      {{ "%d min"|format(total_voice|int) }}
                    {% else %}
                      0 min
                    {% endif %}
                  </p>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card bg-info text-white">
                <div class="card-body text-center">
                  <i class="bi bi-chat-dots fs-2 mb-2"></i>
                  <h6 class="card-title">SMS Usage</h6>
                  <p class="card-text fs-5">
                    {% if result["Monthly Usage"] and result["Monthly Usage"]["incoming_sms"] and result["Monthly Usage"]["outgoing_sms"] %}
                      {% set total_sms = result["Monthly Usage"]["incoming_sms"]|sum + result["Monthly Usage"]["outgoing_sms"]|sum %}
                      {{ "%d messages"|format(total_sms|int) }}
                    {% else %}
                      0 messages
                    {% endif %}
                  </p>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card bg-warning text-white">
                <div class="card-body text-center">
                  <i class="bi bi-calendar-month fs-2 mb-2"></i>
                  <h6 class="card-title">Active Months</h6>
                  <p class="card-text fs-5">
                    {% if result["Monthly Usage"] and result["Monthly Usage"]["months"] %}
                      {{ result["Monthly Usage"]["months"]|length }} months
                    {% else %}
                      0 months
                    {% endif %}
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Usage Trend Summary -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0">
                    <i class="bi bi-graph-up me-2"></i>
                    Insights
                  </h6>
                </div>
                <div class="card-body">
                  {% if result["Monthly Usage"] and result["Monthly Usage"]["months"] and result["Monthly Usage"]["months"]|length > 1 %}
                    {% set months = result["Monthly Usage"]["months"] %}
                    {% set latest_idx = months|length - 1 %}
                    {% set previous_idx = months|length - 2 %}
                    {% set latest_month = months[latest_idx] %}
                    {% set previous_month = months[previous_idx] %}
                    {% set latest_total = result["Monthly Usage"]["Total"][latest_idx] if result["Monthly Usage"]["Total"] and latest_idx < result["Monthly Usage"]["Total"]|length else 0 %}
                    {% set previous_total = result["Monthly Usage"]["Total"][previous_idx] if result["Monthly Usage"]["Total"] and previous_idx < result["Monthly Usage"]["Total"]|length else 0 %}
                    {% set latest_voice = (result["Monthly Usage"]["incoming_voice"][latest_idx] if result["Monthly Usage"]["incoming_voice"] and latest_idx < result["Monthly Usage"]["incoming_voice"]|length else 0) + (result["Monthly Usage"]["outgoing_voice"][latest_idx] if result["Monthly Usage"]["outgoing_voice"] and latest_idx < result["Monthly Usage"]["outgoing_voice"]|length else 0) %}
                    {% set previous_voice = (result["Monthly Usage"]["incoming_voice"][previous_idx] if result["Monthly Usage"]["incoming_voice"] and previous_idx < result["Monthly Usage"]["incoming_voice"]|length else 0) + (result["Monthly Usage"]["outgoing_voice"][previous_idx] if result["Monthly Usage"]["outgoing_voice"] and previous_idx < result["Monthly Usage"]["outgoing_voice"]|length else 0) %}
                    {% set latest_sms = (result["Monthly Usage"]["incoming_sms"][latest_idx] if result["Monthly Usage"]["incoming_sms"] and latest_idx < result["Monthly Usage"]["incoming_sms"]|length else 0) + (result["Monthly Usage"]["outgoing_sms"][latest_idx] if result["Monthly Usage"]["outgoing_sms"] and latest_idx < result["Monthly Usage"]["outgoing_sms"]|length else 0) %}
                    <div class="row">
                      <div class="col-md-6">
                        <strong>Latest Month Activity:</strong>
                        <ul class="list-unstyled mt-2">
                          <li><i class="bi bi-calendar3 me-2 text-primary"></i>{{ latest_month }}</li>
                          <li><i class="bi bi-hdd me-2 text-success"></i>Data: {{ "%.2f MB"|format(latest_total) }}</li>
                          <li><i class="bi bi-telephone me-2 text-info"></i>Voice: {{ latest_voice|int }} min</li>
                          <li><i class="bi bi-chat me-2 text-warning"></i>SMS: {{ latest_sms|int }} messages</li>
                        </ul>
                      </div>
                      <div class="col-md-6">
                        <strong>Usage Trend:</strong>
                        <ul class="list-unstyled mt-2">
                          {% set data_change = latest_total - previous_total %}
                          {% set voice_change = latest_voice - previous_voice %}
                          <li>
                            <i class="bi bi-{% if data_change >= 0 %}arrow-up text-success{% else %}arrow-down text-danger{% endif %} me-2"></i>
                            Data: {% if data_change >= 0 %}+{% endif %}{{ "%.1f MB"|format(data_change) }}
                          </li>
                          <li>
                            <i class="bi bi-{% if voice_change >= 0 %}arrow-up text-success{% else %}arrow-down text-danger{% endif %} me-2"></i>
                            Voice: {% if voice_change >= 0 %}+{% endif %}{{ voice_change|int }} min
                          </li>
                        </ul>
                      </div>
                    </div>
                  {% else %}
                    <p class="text-muted mb-0">
                      <i class="bi bi-info-circle me-2"></i>
                      Insufficient data for trend analysis. At least 2 months of data required.
                    </p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          
          <!-- Usage Charts -->
          <div class="row">
            <!-- Line Chart -->
            <div class="col-md-6 mb-4">
              <div class="card border p-3">
                <div id="monthlyVolumeChart" style="width: 100%; height: 400px"></div>
              </div>
            </div>

            <!-- Bar Chart -->
            <div class="col-md-6 mb-4">
              <div class="card border p-3">
                <div id="totalVolumeChart" style="width: 100%; height: 400px"></div>
              </div>
            </div>

            <!-- Voice Usage Chart -->
            <div class="col-md-6 mb-4">
              <div class="card border p-3">
                <div id="voiceUsageChart" style="width: 100%; height: 400px"></div>
              </div>
            </div>

            <!-- SMS Usage Chart -->
            <div class="col-md-6 mb-4">
              <div class="card border p-3">
                <div id="smsUsageChart" style="width: 100%; height: 400px"></div>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- RSRP Signal Quality Data -->
        {% if result.get('formatted_recent_rsrp') or result.get('formatted_common_rsrp') %}
        <div class="mb-4">
          <h5 class="mb-3">
            <i class="bi bi-reception-4 me-2 text-info"></i>
            RSRP Signal Quality
          </h5>
          
          {% if result.get('formatted_recent_rsrp') %}
          <!-- Current Location RSRP -->
          <div class="card mb-3">
            <div class="card-header">
              <h6 class="mb-0">Current Location</h6>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped table-sm">
                  <thead>
                    <tr>
                      <th>Site Name</th>
                      <th>Site ID</th>
                      <th>Signal Quality</th>
                      <th>Signal Avg</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% if result['formatted_recent_rsrp']['display_type'] == 'summary' and result['formatted_recent_rsrp']['summary_row'] %}
                      <!-- Summary Row for ≤2 sites -->
                      <tr>
                        <td>{{ result['formatted_recent_rsrp']['summary_row']['Site_Name'] }}</td>
                        <td>{{ result['formatted_recent_rsrp']['summary_row']['Site_ID'] }}</td>
                        <td>
                          {% set quality = result['formatted_recent_rsrp']['summary_row']['Signal Quality'] %}
                          <span class="badge bg-{% if 'Good' in quality %}success{% elif 'Poor' in quality %}danger{% else %}secondary{% endif %}">
                            {{ quality }}
                          </span>
                        </td>
                        <td>
                          <span class="badge bg-success">
                            {{ result['formatted_recent_rsrp']['summary_row']['Good_Signal_Avg'] }}
                          </span>
                        </td>
                      </tr>
                    {% elif result['formatted_recent_rsrp']['display_type'] == 'individual' and result['formatted_recent_rsrp']['individual_rows'] %}
                      <!-- Individual Rows for >2 sites -->
                      {% for row in result['formatted_recent_rsrp']['individual_rows'] %}
                      <tr>
                        <td>{{ row['Site_Name'] }}</td>
                        <td>{{ row['Site_ID'] }}</td>
                        <td>
                          <span class="badge bg-{% if row['Signal Quality'] == 'Good' %}success{% else %}danger{% endif %}">
                            {{ row['Signal Quality'] }}
                          </span>
                        </td>
                        <td>
                          <span class="badge bg-success">
                            {{ row['Good_Signal_Avg'] }}
                          </span>
                        </td>
                      </tr>
                      {% endfor %}
                    {% endif %}
                  </tbody>
                </table>
              </div>
              <small class="text-muted">
                <i class="bi bi-info-circle me-1"></i>
                {{ result['formatted_recent_rsrp']['total_sites'] }} total sites: 
                {{ result['formatted_recent_rsrp']['good_count'] }} good, 
                {{ result['formatted_recent_rsrp']['poor_count'] }} poor signal quality
                {% if result['formatted_recent_rsrp'].get('unique_sites') %}
                  ({{ result['formatted_recent_rsrp']['unique_sites'] }} unique sites)
                {% endif %}
                {% if result['formatted_recent_rsrp'].get('overall_good_signal_avg') %}
                  - Overall Good Signal Avg: {{ result['formatted_recent_rsrp']['overall_good_signal_avg'] }}
                {% endif %}
              </small>
            </div>
          </div>
          {% endif %}
          
          {% if result.get('formatted_common_rsrp') %}
          <!-- Common Locations RSRP -->
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0">Common Locations</h6>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped table-sm">
                  <thead>
                    <tr>
                      <th>Site Name</th>
                      <th>Site ID</th>
                      <th>Signal Quality</th>
                      <th>Quality %</th>
                      <th>Good Signal Avg</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% if result['formatted_common_rsrp']['display_type'] == 'summary' and result['formatted_common_rsrp']['summary_row'] %}
                      <!-- Summary Row for ≤2 sites -->
                      <tr>
                        <td>{{ result['formatted_common_rsrp']['summary_row']['Site_Name'] }}</td>
                        <td>{{ result['formatted_common_rsrp']['summary_row']['Site_ID'] }}</td>
                        <td>
                          {% set quality = result['formatted_common_rsrp']['summary_row']['Signal Quality'] %}
                          <span class="badge bg-{% if 'Good' in quality %}success{% elif 'Poor' in quality %}danger{% else %}secondary{% endif %}">
                            {{ quality }}
                          </span>
                        </td>
                        <td>
                          <span class="badge bg-success">
                            {{ result['formatted_common_rsrp']['summary_row']['Good_Signal_Avg'] }}
                          </span>
                        </td>
                      </tr>
                    {% elif result['formatted_common_rsrp']['display_type'] == 'individual' and result['formatted_common_rsrp']['individual_rows'] %}
                      <!-- Individual Rows for >2 sites -->
                      {% for row in result['formatted_common_rsrp']['individual_rows'] %}
                      <tr>
                        <td>{{ row['Site_Name'] }}</td>
                        <td>{{ row['Site_ID'] }}</td>
                        <td>
                          <span class="badge bg-{% if row['Signal Quality'] == 'Good' %}success{% else %}danger{% endif %}">
                            {{ row['Signal Quality'] }}
                          </span>
                        </td>
                        <td>
                          <span class="badge bg-success">
                            {{ row['Good_Signal_Avg'] }}
                          </span>
                        </td>
                      </tr>
                      {% endfor %}
                    {% endif %}
                  </tbody>
                </table>
              </div>
              <small class="text-muted">
                <i class="bi bi-info-circle me-1"></i>
                {{ result['formatted_common_rsrp']['total_sites'] }} total sites: 
                {{ result['formatted_common_rsrp']['good_count'] }} good, 
                {{ result['formatted_common_rsrp']['poor_count'] }} poor signal quality
                {% if result['formatted_common_rsrp'].get('unique_sites') %}
                  ({{ result['formatted_common_rsrp']['unique_sites'] }} unique sites)
                {% endif %}
                {% if result['formatted_common_rsrp'].get('overall_good_signal_avg') %}
                  - Overall Good Signal Avg: {{ result['formatted_common_rsrp']['overall_good_signal_avg'] }}
                {% endif %}
              </small>
            </div>
          </div>
          {% endif %}
        </div>
        {% endif %}

        <!-- Action Buttons -->
        <div class="row mt-4">
          <div class="col-md-6 mb-2">
            <a href="{{ url_for('index', detailed='true', msisdn=result['MSISDN']) }}" class="btn btn-primary w-100">
              <i class="bi bi-list-ul me-2"></i>
              View Detailed Analysis
            </a>
          </div>
          <div class="col-md-6 mb-2">
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary w-100">
              <i class="bi bi-arrow-left me-2"></i>
              New Search
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
  
  <!-- External JavaScript Files -->
  <script src="{{ url_for('static', filename='js/app.js') }}"></script>
  <script src="{{ url_for('static', filename='js/charts.js') }}"></script>

  {% if result and result["Monthly Usage"] %}
  <script id="usage-data" type="application/json">{{ result["Monthly Usage"] | tojson | safe }}</script>
  {% endif %}

  <script>
    // Initialize charts with usage data from server
    document.addEventListener('DOMContentLoaded', function () {
      const usageDataElement = document.getElementById('usage-data');
      if (usageDataElement && typeof initializeUsageCharts === 'function') {
        try {
          const usage = JSON.parse(usageDataElement.textContent);
          initializeUsageCharts(usage);
        } catch (error) {
          console.error('Error parsing usage data:', error);
        }
      }
    });
  </script>
</body>

</html>
